<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Railway Track Visualization</title>
    <style>
        body { margin: 0; padding: 20px; background-color: #000000; font-family: Arial, sans-serif; }
        .container { max-width: 1200px; margin: 0 auto; }
        h1 { text-align: center; margin-bottom: 20px; color: #ffffff; }
        .svg-container { background-color: #000000; border: 2px solid #ffffff; padding: 20px; display: flex; justify-content: center; }
        svg { background-color: #000000; border: 1px solid #ffffff; }
        .controls { margin-top: 30px; padding: 20px; background-color: #000000; border: 2px solid #ffffff; color: #ffffff; }
        .controls.disabled { opacity: 0.4; pointer-events: none; }
        .track-controls { display: grid; grid-template-columns: repeat(auto-fit, minmax(120px, 1fr)); gap: 15px; }
        .track-item { display: flex; flex-direction: column; gap: 8px; padding: 10px; border: 1px solid #ffffff; background-color: #1a1a1a; }
        .track-name { font-weight: bold; font-size: 14px; text-align: center; color: #ffffff; }
        .track-btn { padding: 8px; border: 2px solid #ffffff; font-weight: bold; cursor: pointer; border-radius: 4px; transition: all 0.2s; }
        .track-btn:hover { opacity: 0.8; }
        .track-btn.off { background-color: transparent; color: #ffffff; }
        .track-btn.white { background-color: #ffffff; color: #000; }
        .track-btn.green { background-color: #00ff00; color: #000; }
        .track-btn.red { background-color: #ff0000; color: #fff; }
        .track-btn.yellow { background-color: #ffff00; color: #000; }
        .track-btn.broken { background-color: transparent; color: #ffff00; border-color: #ffff00; }
        .track-btn.magenta { background-color: #ff00ff; color: #fff; }
        .btn-group { display: flex; gap: 5px; }
        .btn-group button { flex: 1; padding: 6px; border: 2px solid #ffffff; font-weight: bold; cursor: pointer; border-radius: 4px; background-color: #333; color: #ffffff; }
        .btn-group button.active { background-color: #0066cc; color: #fff; }
        .section-title { grid-column: 1 / -1; font-weight: bold; margin-bottom: 10px; padding-bottom: 10px; border-bottom: 2px solid #ffffff; color: #ffffff; }
        @keyframes flash1Hz {
            0% { opacity: 1; }
            50% { opacity: 0; }
            100% { opacity: 1; }
        }
        .broken-ring { animation: flash1Hz 1s infinite; }
        .top-controls { display: flex; gap: 20px; margin-bottom: 30px; align-items: center; justify-content: center; }
        .control-group { display: flex; gap: 15px; align-items: center; }
        .control-group label { font-weight: bold; color: #ffffff; font-size: 16px; }
        .control-switch { display: flex; gap: 10px; }
        .control-switch button { padding: 10px 20px; border: 2px solid #ffffff; font-weight: bold; cursor: pointer; border-radius: 4px; transition: all 0.2s; min-width: 80px; }
        .control-switch button.inactive { background-color: #333; color: #ffffff; }
        .control-switch button.active { background-color: #0066cc; color: #ffffff; }
        .power-button { padding: 12px 30px; border: 3px solid #ffffff; font-weight: bold; cursor: pointer; border-radius: 6px; font-size: 16px; transition: all 0.3s; min-width: 100px; }
        .power-button.on { background-color: #00ff00; color: #000; }
        .power-button.off { background-color: #ff0000; color: #fff; }
        .power-button:hover { transform: scale(1.05); }
        .system-status { color: #00ff00; font-weight: bold; font-size: 14px; }
        .system-status.off { color: #ff0000; }
    </style>
</head>
<body>
    <div class="container">
        <h1>Railway Track Visualization - Domino Panel</h1>
        <div class="top-controls">
            <div class="control-group">
                <label>POWER:</label>
                <button class="power-button on" id="powerBtn">ON</button>
            </div>
            <div class="control-group">
                <label>MODE:</label>
                <div class="control-switch">
                    <button class="active" id="vduBtn">VDU</button>
                    <button class="inactive" id="dominoBtn">DOMINO</button>
                </div>
            </div>
            <div id="systemStatus" class="system-status">SYSTEM: READY</div>
        </div>
        <div class="svg-container">
            <svg id="trackSvg" width="1440" height="350" viewBox="0 0 1440 350"></svg>
        </div>
        <div id="routeLog" style="background-color: #000000; border: 2px solid #00ff00; padding: 15px; margin-top: 20px; max-height: 150px; overflow-y: auto; font-family: monospace; color: #00ff00; font-size: 12px; white-space: pre-wrap; word-wrap: break-word;">
            <div style="font-weight: bold; margin-bottom: 10px;">ROUTE LOG:</div>
        </div>
        <div class="controls">
            <h2>Controls</h2>
            <div class="track-controls" id="trackControls"></div>
        </div>
    </div>

    <script>
        // ╔══════════════════════════════════════════════════════════════╗
        // ║                 RAILWAY TRACK VISUALIZATION                 ║
        // ║                    REFACTORED & MODULAR                     ║
        // ╚══════════════════════════════════════════════════════════════╝

        // ════════════════════════════════════════════════════════════════
        // 1. CONFIGURATION & CONSTANTS
        // ════════════════════════════════════════════════════════════════
        const CONFIG = {
            // SVG Canvas
            SVG_WIDTH: 1440,
            SVG_HEIGHT: 350,
            
            // Track Dimensions
            TRACK_WIDTH: 10,
            STANDARD_WIDTH: 193,
            EXTENDED_WIDTH: 244,
            SHORTENED_WIDTH: 161,
            
            // Layout Positions
            START_X: 50,
            UPPER_Y: 150,
            LOWER_Y: 250,
            LABEL_OFFSET_Y: 30,
            
            // Geometric Elements
            TRIANGLE_SIZE: 12,
            TRIANGLE_GAP: 8,
            VERTICAL_LINE_WIDTH: 8,
            GAP_LINE_HEIGHT: 18,
            SIGNAL_RADIUS: 8,
            POLE_WIDTH: 4,
            POLE_HEIGHT: 40,
            HOOD_WIDTH: 20,
            HOOD_HEIGHT: 15
        };

        const COLORS = {
            OFF: '#ff00ff',
            WHITE: '#ffffff',
            GREEN: '#00ff00',
            RED: '#ff0000',
            YELLOW: '#ffff00',
            BLACK: '#000000'
        };

        // ════════════════════════════════════════════════════════════════
        // 2. STATE MANAGEMENT
        // ════════════════════════════════════════════════════════════════
        const state = {
            power: 'on',        // on or off
            mode: 'vdu',        // vdu or domino
            tracks: {
                VA: 'white', VB: 'white', VC_LEFT: 'white', VC_11A: 'white', VC_RIGHT: 'white', VD: 'white',
                AD: 'white', AC: 'white', AB_LEFT: 'white', AB_11B: 'white', AB_RIGHT: 'white', AA: 'white',
                DIAG: 'white'
            },
            signals: {
                N4: 'off',
                T7: 'off',
                S6: 'off',  // Shunt signal: off/green/red
                T5: 'off',  // Shunt signal: off/green/red
                T3: 'off'   // Shunt signal: off/green/red
            },
            hoods: {
                T5: 'empty',    // empty or filled
                T3: 'empty',    // empty or filled
                S6: 'empty'     // empty or filled
            },
            switches: {
                '11A': 'NORMAL',
                '11B': 'NORMAL'
            },
            switchStates: {
                '11A': 'OK',      // OK or broken
                '11B': 'OK'       // OK or broken
            }
        };

        // Route management
        const routeState = {
            selectedTriangle: null,
            routeLog: []
        };

        // Triangle registry to map coordinates to signal names and directions
        const triangleRegistry = {};

        function addTriangleToRegistry(elementId, signalName, direction) {
            triangleRegistry[elementId] = { signalName, direction };
        }

        function logRoute(fromSignal, fromDirection, toSignal, toDirection, isValid = true, errorMessage = '') {
            let routeString;
            if (isValid) {
                routeString = `Route set: ${fromSignal} ${fromDirection} --> ${toSignal} ${toDirection}`;
            } else {
                routeString = `Invalid route: ${fromSignal} ${fromDirection} --> ${toSignal} ${toDirection} (${errorMessage})`;
            }
            
            routeState.routeLog.push(routeString);
            console.log(routeString);
            
            // Display in page route log
            const logContainer = document.getElementById('routeLog');
            if (logContainer) {
                const logEntry = document.createElement('div');
                logEntry.textContent = routeString;
                if (isValid) {
                    logEntry.style.color = '#00ff00';  // Green for valid
                } else {
                    logEntry.style.color = '#ff0000';  // Red for invalid
                }
                logEntry.style.fontFamily = 'monospace';
                logEntry.style.padding = '5px';
                logContainer.appendChild(logEntry);
                logContainer.scrollTop = logContainer.scrollHeight; // Auto scroll to bottom
            }
        }

        // Valid route combinations based on actual track topology and triangle directions
        // N4: has both Utara and Selatan triangles
        // T3: has both Utara and Selatan triangles
        // T7: has only Selatan triangle (no Utara)
        // T5: has only Selatan triangle (no Utara)
        const validRoutes = {
            // Top line (N4 ↔ T3)
            'N4-Utara Direction': ['T3-Utara Direction'],      // N4 Utara → T3 Utara ✅
            'T3-Selatan Direction': ['N4-Selatan Direction'],  // T3 Selatan → N4 Selatan ✅
            
            // Bottom line (T5 ↔ T7) - only Selatan direction available
            'T5-Selatan Direction': ['T7-Selatan Direction'],  // T5 Selatan → T7 Selatan ✅
            
            // Cross via DIAG: T3 Selatan → T7 Selatan (via T5)
            'T3-Selatan Direction': ['N4-Selatan Direction', 'T7-Selatan Direction']  // T3 Selatan → N4 Selatan or T7 Selatan ✅
        };

        // Error messages for specific invalid routes
        const invalidRouteMessages = {
            'N4-Selatan Direction|T3-Selatan Direction': 'wrong sequence',
            'T3-Utara Direction|N4-Utara Direction': 'wrong sequence',
            'T5-Utara Direction|T7-Utara Direction': 'no Utara triangle',
            'T7-Selatan Direction|T5-Selatan Direction': 'wrong sequence',
            'T7-Utara Direction|T5-Utara Direction': 'no Utara triangle',
            'T3-Selatan Direction|T5-Selatan Direction': 'impossible',
            'T3-Utara Direction|T7-Utara Direction': 'no Utara triangle',
            'T5-Selatan Direction|T3-Selatan Direction': 'impossible',
            'T7-Selatan Direction|T3-Selatan Direction': 'wrong sequence'
        };

        function getInvalidRouteMessage(fromSignal, fromDirection, toSignal, toDirection) {
            const routeKey = `${fromSignal}-${fromDirection}|${toSignal}-${toDirection}`;
            return invalidRouteMessages[routeKey] || 'invalid route';
        }

        function isValidRoute(fromSignal, fromDirection, toSignal, toDirection) {
            const fromKey = `${fromSignal}-${fromDirection}`;
            const toKey = `${toSignal}-${toDirection}`;
            
            if (!validRoutes[fromKey]) {
                return false;
            }
            
            return validRoutes[fromKey].includes(toKey);
        }

        function handleTriangleClick(signalName, direction) {
            // Don't allow route setting when power is off
            if (state.power === 'off') {
                console.log('Cannot set routes - system power is OFF');
                return;
            }

            if (!routeState.selectedTriangle) {
                routeState.selectedTriangle = { signalName, direction, isShunt: false };
                console.log(`Route origin selected: ${signalName} ${direction}`);
            } else {
                const from = routeState.selectedTriangle;
                
                // Check if trying to connect main route to shunt route
                if (from.isShunt) {
                    const errorMessage = 'Cannot connect shunt route to main route';
                    logRoute(from.signalName, from.direction, signalName, direction, false, errorMessage);
                } else {
                    // Check if route is valid (main-to-main only)
                    if (isValidRoute(from.signalName, from.direction, signalName, direction)) {
                        logRoute(from.signalName, from.direction, signalName, direction, true);
                    } else {
                        const errorMessage = getInvalidRouteMessage(from.signalName, from.direction, signalName, direction);
                        logRoute(from.signalName, from.direction, signalName, direction, false, errorMessage);
                    }
                }
                
                routeState.selectedTriangle = null;
            }
        }

        function isValidShuntRoute(fromSignal, toSignal) {
            // Define valid shunt route connections
            // S6 can connect to T5 and T3
            // T5 can only connect to S6
            // T3 can only connect to S6
            // Cannot connect to same shunt (T5->T5, T3->T3, S6->S6 invalid)
            // T5 and T3 cannot connect to each other
            
            if (fromSignal === toSignal) {
                return false; // Cannot connect to itself
            }
            
            const validShuntConnections = {
                'S6': ['T5', 'T3'],
                'T5': ['S6'],
                'T3': ['S6']
            };
            
            return validShuntConnections[fromSignal] && 
                   validShuntConnections[fromSignal].includes(toSignal);
        }

        function handleShuntRouteClick(signalName, routeType) {
            // Don't allow route setting when power is off
            if (state.power === 'off') {
                console.log('Cannot set shunt routes - system power is OFF');
                return;
            }

            if (!routeState.selectedTriangle) {
                routeState.selectedTriangle = { signalName, direction: routeType, isShunt: true };
                console.log(`Shunt route origin selected: ${signalName} ${routeType}`);
            } else {
                const from = routeState.selectedTriangle;
                
                // Only allow shunt-to-shunt routes
                if (from.isShunt && routeType === 'Shunt') {
                    // Check if shunt connection is valid
                    if (isValidShuntRoute(from.signalName, signalName)) {
                        logRoute(from.signalName, from.direction, signalName, routeType, true);
                    } else {
                        const errorMessage = `Shunt route ${from.signalName} cannot connect to ${signalName}`;
                        logRoute(from.signalName, from.direction, signalName, routeType, false, errorMessage);
                    }
                } else if (!from.isShunt) {
                    // First click was a main route, can't connect to shunt
                    const errorMessage = 'Cannot connect main route to shunt route';
                    logRoute(from.signalName, from.direction, signalName, routeType, false, errorMessage);
                } else {
                    // First click was a shunt, but this isn't a valid destination
                    const errorMessage = 'Shunt routes can only connect to other shunt routes';
                    logRoute(from.signalName, from.direction, signalName, routeType, false, errorMessage);
                }
                
                routeState.selectedTriangle = null;
            }
        }

        // ════════════════════════════════════════════════════════════════
        // 3. COLOR & UTILITY FUNCTIONS
        // ════════════════════════════════════════════════════════════════
        function getColor(trackState) {
            if (state.power === 'off') return COLORS.OFF;
            
            const colorMap = {
                'green': COLORS.GREEN,
                'red': COLORS.RED,
                'yellow': COLORS.YELLOW,
                'white': COLORS.WHITE,
                'magenta': COLORS.OFF
            };
            return colorMap[trackState] || COLORS.OFF;
        }

        function getSignalColor(signalState) {
            if (state.power === 'off') return 'none';
            
            const colorMap = {
                'green': COLORS.GREEN,
                'red': COLORS.RED,
                'yellow': COLORS.YELLOW,
                'white': COLORS.WHITE
            };
            return colorMap[signalState] || 'none';
        }

        function getDefaultColor() {
            return state.power === 'off' ? COLORS.OFF : COLORS.WHITE;
        }

        // ════════════════════════════════════════════════════════════════
        // 4. EVENT HANDLERS & ROUTING
        // ════════════════════════════════════════════════════════════════
        function togglePower() {
            state.power = state.power === 'on' ? 'off' : 'on';
            updatePowerUI();
            render();
        }

        function setMode(newMode) {
            if (state.power === 'off') return; // Can't change mode when power is off
            state.mode = newMode;
            updateModeUI();
            render();
        }

        function updatePowerUI() {
            const powerBtn = document.getElementById('powerBtn');
            const statusDiv = document.getElementById('systemStatus');
            
            if (state.power === 'on') {
                powerBtn.textContent = 'ON';
                powerBtn.className = 'power-button on';
                statusDiv.textContent = `SYSTEM: READY (${state.mode.toUpperCase()})`;
                statusDiv.className = 'system-status';
            } else {
                powerBtn.textContent = 'OFF';
                powerBtn.className = 'power-button off';
                statusDiv.textContent = 'SYSTEM: OFFLINE';
                statusDiv.className = 'system-status off';
            }
        }

        function updateModeUI() {
            const vduBtn = document.getElementById('vduBtn');
            const dominoBtn = document.getElementById('dominoBtn');
            
            if (state.mode === 'vdu') {
                vduBtn.className = 'active';
                dominoBtn.className = 'inactive';
            } else {
                vduBtn.className = 'inactive';
                dominoBtn.className = 'active';
            }
            updatePowerUI();
        }

        // ════════════════════════════════════════════════════════════════
        // 5. STATE MODIFICATION FUNCTIONS
        // ════════════════════════════════════════════════════════════════
        function cycleState(trackName) {
            if (state.power === 'off') return; // Disable when power is off
            if (state.tracks[trackName] === 'magenta') state.tracks[trackName] = 'white';
            else if (state.tracks[trackName] === 'white') state.tracks[trackName] = 'green';
            else if (state.tracks[trackName] === 'green') state.tracks[trackName] = 'red';
            else state.tracks[trackName] = 'magenta';
            
            // When cycling VC, update all VC parts if 11A is NORMAL
            if (trackName === 'VC_LEFT' && state.switches['11A'] === 'NORMAL') {
                state.tracks['VC_RIGHT'] = state.tracks['VC_LEFT'];
                state.tracks['VC_11A'] = state.tracks['VC_LEFT'];
            }
            // When cycling AB, update all AB parts if 11B is NORMAL
            if (trackName === 'AB_LEFT' && state.switches['11B'] === 'NORMAL') {
                state.tracks['AB_RIGHT'] = state.tracks['AB_LEFT'];
                state.tracks['AB_11B'] = state.tracks['AB_LEFT'];
            }
            
            render();
        }

        function cycleSignal(signalName) {
            if (state.power === 'off') return; // Disable when power is off
            if (state.signals[signalName] === 'off' || state.signals[signalName] === 'magenta') state.signals[signalName] = 'green';
            else if (state.signals[signalName] === 'green') state.signals[signalName] = 'red';
            else if (state.signals[signalName] === 'red') state.signals[signalName] = 'broken';
            else state.signals[signalName] = 'off';
            render();
        }

        function cycleSignalT5() {
            if (state.power === 'off') return; // Disable when power is off
            // Cycle through off/green/red/broken for shunt signal
            if (state.signals.T5 === 'off' || state.signals.T5 === 'magenta') state.signals.T5 = 'green';
            else if (state.signals.T5 === 'green') state.signals.T5 = 'red';
            else if (state.signals.T5 === 'red') state.signals.T5 = 'broken';
            else state.signals.T5 = 'off';
            render();
        }

        function cycleSignalT3() {
            if (state.power === 'off') return; // Disable when power is off
            // Cycle through off/green/red/broken for shunt signal
            if (state.signals.T3 === 'off' || state.signals.T3 === 'magenta') state.signals.T3 = 'green';
            else if (state.signals.T3 === 'green') state.signals.T3 = 'red';
            else if (state.signals.T3 === 'red') state.signals.T3 = 'broken';
            else state.signals.T3 = 'off';
            render();
        }

        function cycleSignalS6() {
            if (state.power === 'off') return; // Disable when power is off
            // Cycle through off/green/red/broken for S6 signal
            if (state.signals.S6 === 'off' || state.signals.S6 === 'magenta') state.signals.S6 = 'green';
            else if (state.signals.S6 === 'green') state.signals.S6 = 'red';
            else if (state.signals.S6 === 'red') state.signals.S6 = 'broken';
            else state.signals.S6 = 'off';
            render();
        }

        function toggleSwitch(switchName) {
            if (state.power === 'off') return; // Disable when power is off
            state.switches[switchName] = state.switches[switchName] === 'NORMAL' ? 'REVERSE' : 'NORMAL';
            render();
        }

        function toggleSwitchState(switchName) {
            if (state.power === 'off') return; // Disable when power is off
            state.switchStates[switchName] = state.switchStates[switchName] === 'OK' ? 'broken' : 'OK';
            render();
        }

        function toggleHood(hoodName) {
            if (state.power === 'off') return; // Disable when power is off
            state.hoods[hoodName] = state.hoods[hoodName] === 'empty' ? 'filled' : 'empty';
            render();
        }

        // ════════════════════════════════════════════════════════════════
        // 6. SVG DRAWING & RENDERING FUNCTIONS
        // ════════════════════════════════════════════════════════════════
        function drawTrack() {
            const svg = document.getElementById('trackSvg');
            svg.innerHTML = '';

            const bg = document.createElementNS('http://www.w3.org/2000/svg', 'rect');
            bg.setAttribute('width', '1440');
            bg.setAttribute('height', '350');
            bg.setAttribute('fill', '#000000');
            svg.appendChild(bg);

            const upperY = 100, lowerY = 250;
            const standardWidth = 193, extendedWidth = 331;
            
            // Calculate total track width
            // VA(146px) + tri_space(60px) + VB(168px) + gap(8px) + VC(extended+40) + gap(40px) + VD(168px)
            // = same as original since VA shortened by 22px but triangles+gaps add 22px
            const totalTrackWidth = standardWidth + 40 + standardWidth + 8 + (extendedWidth + 40) + 40 + standardWidth;
            
            // Center the tracks on the 1440px canvas
            const startX = (1440 - totalTrackWidth) / 2;

            // Helper functions
            function drawSection(x1, x2, y, trackName) {
                const line = document.createElementNS('http://www.w3.org/2000/svg', 'line');
                line.setAttribute('x1', x1);
                line.setAttribute('y1', y);
                line.setAttribute('x2', x2);
                line.setAttribute('y2', y);
                line.setAttribute('stroke', getColor(state.tracks[trackName]));
                line.setAttribute('stroke-width', '10');
                line.setAttribute('stroke-linecap', 'butt');
                svg.appendChild(line);
            }

            function drawLabel(x, y, text) {
                const label = document.createElementNS('http://www.w3.org/2000/svg', 'text');
                label.setAttribute('x', x);
                label.setAttribute('y', y);
                label.setAttribute('text-anchor', 'middle');
                label.setAttribute('font-size', '14');
                label.setAttribute('font-weight', 'bold');
                label.setAttribute('fill', getDefaultColor());
                label.textContent = text;
                svg.appendChild(label);
            }

            // ===== UPPER LINE =====
            let x = startX;

            // VA - shortened to accommodate: tri1(24px) + 8px gap + tri2(24px) = 56px total
            // Original gap was 40px, so VA needs to be shortened by -16px (but we add 8px extension)
            const vaWidth = standardWidth - 32;  // 193 - 32 = 161px
            drawSection(x, x + vaWidth, upperY, 'VA');
            drawLabel(x + vaWidth / 2, upperY - 30, 'VA');
            const vaEnd = x + vaWidth;
            
            // Triangles positioned after VA (no gap before triangle)
            // Left triangle (SELATAN facing, points left)
            const vaVb_triangle1_x = vaEnd + 12;  // No gap, directly at 12px from vaEnd
            // Right triangle (UTARA facing, points right)  
            const vaVb_triangle2_x = vaEnd + 24 + 8 + 12;  // tri1(24) + 8px gap (between triangles only) + 12px offset
            
            // VB starts directly after the second triangle (no gap)
            // VB needs to start where the triangle ends: vaEnd + 24 + 8 + 24
            const vbStart = vaEnd + 24 + 8 + 24;
            x = vbStart;

            // VB
            drawSection(x, x + standardWidth, upperY, 'VB');
            drawLabel(x + standardWidth / 2, upperY - 30, 'VB');
            const vbEnd = x + standardWidth;
            x += standardWidth + 8;

            // VC (3 parts: LEFT, 11A, RIGHT)
            const vcStart = x;
            const vc11A_start = vcStart + extendedWidth * 0.75;  // 3/4 position
            const vc11A_end = vc11A_start + 40;  // Small 11A section
            const vcLeft_end = vc11A_start + 10;  // Overlap by 10px to close gap
            const vcRight_start = vc11A_end - 10;  // Overlap by 10px to close gap
            const vcRight_end = vcStart + extendedWidth + 40;  // +40px bigger

            // If 11A is NORMAL, draw full VC line; if REVERSE draw LEFT and RIGHT separately
            if (state.switches['11A'] === 'NORMAL') {
                drawSection(vcStart, vcRight_end, upperY, 'VC_LEFT');  // Draw full continuous line
            } else {
                drawSection(vcStart, vcLeft_end, upperY, 'VC_LEFT');
                drawSection(vcRight_start, vcRight_end, upperY, 'VC_RIGHT');
            }
            drawLabel(vcStart + 60, upperY - 30, 'VC');
            drawLabel(vc11A_start + 20, upperY - 30, '11A');
            
            const vcRightSize = vcRight_end - vcRight_start;
            const vcEnd = vcRight_end;
            
            // Pre-calculate VC-VD right triangle position for alignment with AB-AA
            const vcVd_triangle2_x = vcEnd + 24 + 8 + 12;  // tri1(24) + 8px gap (between triangles only) + 12px offset
            
            // VD starts directly after the VC-VD triangle pair (no gap before)
            // Triangles will be at: vcEnd + 12 (tri1), vcVd_triangle2_x (tri2)
            // VD starts after tri2: vcVd_triangle2_x + 12 + 12 = vcVd_triangle2_x + 24
            const vdStart = vcVd_triangle2_x + 12;
            const vdWidth = standardWidth - 32;  // 193 - 32 = 161px
            drawSection(vdStart, vdStart + vdWidth, upperY, 'VD');
            drawLabel(vdStart + vdWidth / 2, upperY - 30, 'VD');

            // ===== LOWER LINE =====
            x = startX;

            // AD
            drawSection(x, x + standardWidth, lowerY, 'AD');
            drawLabel(x + standardWidth / 2, lowerY + 30, 'AD');
            const adEnd = x + standardWidth;

            // AC starts directly after AD-AC triangle (no gap before triangle)
            // Triangle at: adEnd + 12, so AC starts at: adEnd + 24
            const acStart = adEnd + 24;
            drawSection(acStart, vbEnd, lowerY, 'AC');  // Extend AC to vertical line left border
            const acMidpoint = acStart + (vbEnd - acStart) / 2;  // Center of AC section
            drawLabel(acMidpoint, lowerY + 30, 'AC');
            const acEnd = vbEnd;

            // AB (3 parts: LEFT, 11B, RIGHT)
            // AB starts directly after AC-AB vertical line right border (no gap)
            // Vertical line is at vbEnd, width 8px, so AB starts at vbEnd + 8
            const abStart = vbEnd + 8;
            const abLeft_end = abStart + vcRightSize + 1;  // Same size as VC_RIGHT + overlap
            const ab11B_start = abLeft_end - 10;  // Overlap by 10px
            const ab11B_end = ab11B_start + 40;  // Small 11B section
            const abRight_start = ab11B_end - 10;  // Overlap by 10px
            const abRight_end = abStart + extendedWidth + 40;  // +40px bigger (same as VC)

            // If 11B is NORMAL, draw full AB line until the AB-Triangle gap vertical line; if REVERSE draw LEFT and RIGHT separately
            const abTriangleGapX_calc = vcEnd + 24;  // Left border of vertical line at AB-Triangle gap
            if (state.switches['11B'] === 'NORMAL') {
                drawSection(abStart, abTriangleGapX_calc, lowerY, 'AB_LEFT');  // Extend to left border of vertical line
            } else {
                drawSection(abStart, abLeft_end, lowerY, 'AB_LEFT');
                drawSection(abRight_start, abTriangleGapX_calc, lowerY, 'AB_RIGHT');  // Extend to left border of vertical line
            }
            drawLabel(abRight_end - 60, lowerY + 30, 'AB');
            drawLabel(ab11B_start + 20, lowerY + 30, '11B');
            const abEnd = abTriangleGapX_calc;  // End at left border of vertical line

            // AA starts directly at the AB-AA triangle right edge (no gap - matching VD)
            // Triangle center at: vcVd_triangle2_x, so triangle right edge: vcVd_triangle2_x + 12
            // AA starts immediately after: vcVd_triangle2_x + 12
            const aaStart = vcVd_triangle2_x + 12;
            const aaWidth = standardWidth - 32;  // 193 - 32 = 161px (SAME as VD)
            drawSection(aaStart, aaStart + aaWidth, lowerY, 'AA');
            drawLabel(aaStart + aaWidth / 2, lowerY + 30, 'AA');
            const aaEnd = aaStart + aaWidth;

            
            // ===== VERTICAL LINES AT GAPS (replacing remaining 8px gaps) =====
            // Triangle base is 24px, height is 18px
            const gapLineHeight = 18;
            const lineWidth = 8;
            
            // Vertical line at Triangle1-Triangle2 gap (upper track, between VA-VB triangles)
            const triangle1Triangle2GapX = vaEnd + 24;
            const triangle1Triangle2LineY_top = upperY - gapLineHeight / 2;
            const triangle1Triangle2LineY_bottom = upperY + gapLineHeight / 2;
            
            const triangle1Triangle2Line = document.createElementNS('http://www.w3.org/2000/svg', 'rect');
            triangle1Triangle2Line.setAttribute('x', triangle1Triangle2GapX);
            triangle1Triangle2Line.setAttribute('y', triangle1Triangle2LineY_top);
            triangle1Triangle2Line.setAttribute('width', lineWidth);
            triangle1Triangle2Line.setAttribute('height', gapLineHeight);
            triangle1Triangle2Line.setAttribute('fill', getDefaultColor());
            triangle1Triangle2Line.setAttribute('stroke', 'none');
            svg.appendChild(triangle1Triangle2Line);
            
            // Vertical line at VB-VC gap (upper track)
            const vbVcGapX = vbEnd;
            const vbVcLineY_top = upperY - gapLineHeight / 2;
            const vbVcLineY_bottom = upperY + gapLineHeight / 2;
            
            const vbVcLine = document.createElementNS('http://www.w3.org/2000/svg', 'rect');
            vbVcLine.setAttribute('x', vbVcGapX);
            vbVcLine.setAttribute('y', vbVcLineY_top);
            vbVcLine.setAttribute('width', lineWidth);
            vbVcLine.setAttribute('height', gapLineHeight);
            vbVcLine.setAttribute('fill', getDefaultColor());
            vbVcLine.setAttribute('stroke', 'none');
            svg.appendChild(vbVcLine);
            
            // Vertical line at VC-VD Triangle1-Triangle2 gap (upper track, between VC-VD triangles)
            const vcVdTriangle1Triangle2GapX = vcEnd + 24;
            const vcVdTriangle1Triangle2LineY_top = upperY - gapLineHeight / 2;
            const vcVdTriangle1Triangle2LineY_bottom = upperY + gapLineHeight / 2;
            
            const vcVdTriangle1Triangle2Line = document.createElementNS('http://www.w3.org/2000/svg', 'rect');
            vcVdTriangle1Triangle2Line.setAttribute('x', vcVdTriangle1Triangle2GapX);
            vcVdTriangle1Triangle2Line.setAttribute('y', vcVdTriangle1Triangle2LineY_top);
            vcVdTriangle1Triangle2Line.setAttribute('width', lineWidth);
            vcVdTriangle1Triangle2Line.setAttribute('height', gapLineHeight);
            vcVdTriangle1Triangle2Line.setAttribute('fill', getDefaultColor());
            vcVdTriangle1Triangle2Line.setAttribute('stroke', 'none');
            svg.appendChild(vcVdTriangle1Triangle2Line);
            
            // Vertical line at AC-AB gap (lower track) - aligned with VB-VC vertical line
            const acAbGapX = vbEnd;  // Same X position as VB-VC line
            const acAbLineY_top = lowerY - gapLineHeight / 2;
            const acAbLineY_bottom = lowerY + gapLineHeight / 2;
            
            const acAbLine = document.createElementNS('http://www.w3.org/2000/svg', 'rect');
            acAbLine.setAttribute('x', acAbGapX);
            acAbLine.setAttribute('y', acAbLineY_top);
            acAbLine.setAttribute('width', lineWidth);
            acAbLine.setAttribute('height', gapLineHeight);
            acAbLine.setAttribute('fill', getDefaultColor());
            acAbLine.setAttribute('stroke', 'none');
            svg.appendChild(acAbLine);
            
            // Shunt route button symbol (_\) for S6 above AC-AB vertical line
            const shuntRouteS6_startX = acAbGapX + lineWidth;  // Start at right border of vertical line
            const shuntRouteS6_centerY = acAbLineY_top - 10;  // Closer to the vertical line (was -20)
            const shuntRouteS6_size = 10;
            
            // Horizontal line (_) - left edge aligned to right border of vertical line
            const shuntRouteS6_horizontal = document.createElementNS('http://www.w3.org/2000/svg', 'line');
            shuntRouteS6_horizontal.setAttribute('x1', shuntRouteS6_startX);
            shuntRouteS6_horizontal.setAttribute('y1', shuntRouteS6_centerY);
            shuntRouteS6_horizontal.setAttribute('x2', shuntRouteS6_startX + shuntRouteS6_size);
            shuntRouteS6_horizontal.setAttribute('y2', shuntRouteS6_centerY);
            shuntRouteS6_horizontal.setAttribute('stroke', getDefaultColor());
            shuntRouteS6_horizontal.setAttribute('stroke-width', '2');
            shuntRouteS6_horizontal.setAttribute('stroke-linecap', 'round');
            shuntRouteS6_horizontal.setAttribute('cursor', 'pointer');
            shuntRouteS6_horizontal.setAttribute('data-signal', 'S6');
            shuntRouteS6_horizontal.onclick = () => handleShuntRouteClick('S6', 'Shunt');
            svg.appendChild(shuntRouteS6_horizontal);
            
            // 45-degree line (\) - diagonal going up-left from right end of horizontal line (80%)
            const shuntRouteS6_diagonal = document.createElementNS('http://www.w3.org/2000/svg', 'line');
            shuntRouteS6_diagonal.setAttribute('x1', shuntRouteS6_startX + shuntRouteS6_size);
            shuntRouteS6_diagonal.setAttribute('y1', shuntRouteS6_centerY);
            shuntRouteS6_diagonal.setAttribute('x2', shuntRouteS6_startX + shuntRouteS6_size / 5);
            shuntRouteS6_diagonal.setAttribute('y2', shuntRouteS6_centerY - shuntRouteS6_size * 0.8);
            shuntRouteS6_diagonal.setAttribute('stroke', getDefaultColor());
            shuntRouteS6_diagonal.setAttribute('stroke-width', '2');
            shuntRouteS6_diagonal.setAttribute('stroke-linecap', 'round');
            shuntRouteS6_diagonal.setAttribute('cursor', 'pointer');
            shuntRouteS6_diagonal.setAttribute('data-signal', 'S6');
            shuntRouteS6_diagonal.onclick = () => handleShuntRouteClick('S6', 'Shunt');
            svg.appendChild(shuntRouteS6_diagonal);
            
            // Vertical line at AD-Triangle gap (lower track, before AD-AC triangle)
            // Left border should align with triangle tip, same X axis as VA-VB vertical line
            const adTriangleGapX = triangle1Triangle2GapX;  // Same X position as VA-VB triangle1-triangle2 line
            const adTriangleLineY_top = lowerY - gapLineHeight / 2;
            const adTriangleLineY_bottom = lowerY + gapLineHeight / 2;
            
            const adTriangleLine = document.createElementNS('http://www.w3.org/2000/svg', 'rect');
            adTriangleLine.setAttribute('x', adTriangleGapX);
            adTriangleLine.setAttribute('y', adTriangleLineY_top);
            adTriangleLine.setAttribute('width', lineWidth);
            adTriangleLine.setAttribute('height', gapLineHeight);
            adTriangleLine.setAttribute('fill', getDefaultColor());
            adTriangleLine.setAttribute('stroke', 'none');
            svg.appendChild(adTriangleLine);
            
            // Vertical line at AB-Triangle gap (lower track) - aligned with VC-VD right triangle vertical line
            const abTriangleGapX = vcVdTriangle1Triangle2GapX;  // Same X position as VC-VD triangle1-triangle2 line
            const abTriangleLineY_top = lowerY - gapLineHeight / 2;
            const abTriangleLineY_bottom = lowerY + gapLineHeight / 2;
            
            const abTriangleLine = document.createElementNS('http://www.w3.org/2000/svg', 'rect');
            abTriangleLine.setAttribute('x', abTriangleGapX);
            abTriangleLine.setAttribute('y', abTriangleLineY_top);
            abTriangleLine.setAttribute('width', lineWidth);
            abTriangleLine.setAttribute('height', gapLineHeight);
            abTriangleLine.setAttribute('fill', getDefaultColor());
            abTriangleLine.setAttribute('stroke', 'none');
            svg.appendChild(abTriangleLine);
            
            // Shunt route button symbol (_\) for T5 below AB-Triangle vertical line - flipped vertically and horizontally
            const shuntRouteT5_startX = abTriangleGapX;  // Start at left border of vertical line
            const shuntRouteT5_centerY = abTriangleLineY_bottom + 10;  // Below the vertical line
            const shuntRouteT5_size = 10;
            
            // Horizontal line (_) - right edge aligned to left border of vertical line
            const shuntRouteT5_horizontal = document.createElementNS('http://www.w3.org/2000/svg', 'line');
            shuntRouteT5_horizontal.setAttribute('x1', shuntRouteT5_startX);
            shuntRouteT5_horizontal.setAttribute('y1', shuntRouteT5_centerY);
            shuntRouteT5_horizontal.setAttribute('x2', shuntRouteT5_startX - shuntRouteT5_size);
            shuntRouteT5_horizontal.setAttribute('y2', shuntRouteT5_centerY);
            shuntRouteT5_horizontal.setAttribute('stroke', getDefaultColor());
            shuntRouteT5_horizontal.setAttribute('stroke-width', '2');
            shuntRouteT5_horizontal.setAttribute('stroke-linecap', 'round');
            shuntRouteT5_horizontal.setAttribute('cursor', 'pointer');
            shuntRouteT5_horizontal.setAttribute('data-signal', 'T5');
            shuntRouteT5_horizontal.onclick = () => handleShuntRouteClick('T5', 'Shunt');
            svg.appendChild(shuntRouteT5_horizontal);
            
            // 45-degree line (/) - diagonal going DOWN-right from left end of horizontal line (80%, flipped horizontally)
            const shuntRouteT5_diagonal = document.createElementNS('http://www.w3.org/2000/svg', 'line');
            shuntRouteT5_diagonal.setAttribute('x1', shuntRouteT5_startX - shuntRouteT5_size);
            shuntRouteT5_diagonal.setAttribute('y1', shuntRouteT5_centerY);
            shuntRouteT5_diagonal.setAttribute('x2', shuntRouteT5_startX - shuntRouteT5_size / 5);
            shuntRouteT5_diagonal.setAttribute('y2', shuntRouteT5_centerY + shuntRouteT5_size * 0.8);
            shuntRouteT5_diagonal.setAttribute('stroke', getDefaultColor());
            shuntRouteT5_diagonal.setAttribute('stroke-width', '2');
            shuntRouteT5_diagonal.setAttribute('stroke-linecap', 'round');
            shuntRouteT5_diagonal.setAttribute('cursor', 'pointer');
            shuntRouteT5_diagonal.setAttribute('data-signal', 'T5');
            shuntRouteT5_diagonal.onclick = () => handleShuntRouteClick('T5', 'Shunt');
            svg.appendChild(shuntRouteT5_diagonal);
            
            
            // ===== TRIANGLE BETWEEN VC AND VD =====
            // Two triangles: one pointing right (UTARA), one pointing left (SELATAN)
            const vcVdTriangleY = upperY;  // Same level as upper track
            const vcVd_triangle_size = 12;
            
            // Left triangle (UTARA facing, points right)
            const vcVd_triangle1_x = vcEnd + 12;  // No gap, directly at 12px offset
            const triangle_vc_vd_utara = document.createElementNS('http://www.w3.org/2000/svg', 'polygon');
            triangle_vc_vd_utara.setAttribute('points', `${vcVd_triangle1_x - vcVd_triangle_size},${vcVdTriangleY - vcVd_triangle_size} ${vcVd_triangle1_x - vcVd_triangle_size},${vcVdTriangleY + vcVd_triangle_size} ${vcVd_triangle1_x + vcVd_triangle_size},${vcVdTriangleY}`);
            triangle_vc_vd_utara.setAttribute('fill', state.power === 'off' ? '#ff00ff' : '#ffffff');
            triangle_vc_vd_utara.setAttribute('stroke', getDefaultColor());
            triangle_vc_vd_utara.setAttribute('stroke-width', '2');
            triangle_vc_vd_utara.setAttribute('cursor', 'pointer');
            triangle_vc_vd_utara.onclick = () => handleTriangleClick('T3', 'Utara Direction');
            svg.appendChild(triangle_vc_vd_utara);
            
            // Right triangle (SELATAN facing, points left)
            const triangle_vc_vd_selatan = document.createElementNS('http://www.w3.org/2000/svg', 'polygon');
            triangle_vc_vd_selatan.setAttribute('points', `${vcVd_triangle2_x + vcVd_triangle_size},${vcVdTriangleY - vcVd_triangle_size} ${vcVd_triangle2_x + vcVd_triangle_size},${vcVdTriangleY + vcVd_triangle_size} ${vcVd_triangle2_x - vcVd_triangle_size},${vcVdTriangleY}`);
            triangle_vc_vd_selatan.setAttribute('fill', state.power === 'off' ? '#ff00ff' : '#ffffff');
            triangle_vc_vd_selatan.setAttribute('stroke', getDefaultColor());
            triangle_vc_vd_selatan.setAttribute('stroke-width', '2');
            triangle_vc_vd_selatan.setAttribute('cursor', 'pointer');
            triangle_vc_vd_selatan.onclick = () => handleTriangleClick('T3', 'Selatan Direction');
            svg.appendChild(triangle_vc_vd_selatan);

            // Shunt route button symbol (_\) for T3 at left edge of left VC-VD triangle (VC side)
            const shuntRouteT3_startX = vcVd_triangle1_x - vcVd_triangle_size;  // Aligned with LEFT edge of left triangle
            const shuntRouteT3_centerY = vcVdTriangleY + vcVd_triangle_size + 10;  // Below the base of left triangle
            const shuntRouteT3_size = 10;
            
            // Horizontal line (_) - right edge aligned to left edge of left triangle
            const shuntRouteT3_horizontal = document.createElementNS('http://www.w3.org/2000/svg', 'line');
            shuntRouteT3_horizontal.setAttribute('x1', shuntRouteT3_startX);
            shuntRouteT3_horizontal.setAttribute('y1', shuntRouteT3_centerY);
            shuntRouteT3_horizontal.setAttribute('x2', shuntRouteT3_startX - shuntRouteT3_size);
            shuntRouteT3_horizontal.setAttribute('y2', shuntRouteT3_centerY);
            shuntRouteT3_horizontal.setAttribute('stroke', getDefaultColor());
            shuntRouteT3_horizontal.setAttribute('stroke-width', '2');
            shuntRouteT3_horizontal.setAttribute('stroke-linecap', 'round');
            shuntRouteT3_horizontal.setAttribute('cursor', 'pointer');
            shuntRouteT3_horizontal.setAttribute('data-signal', 'T3');
            shuntRouteT3_horizontal.onclick = () => handleShuntRouteClick('T3', 'Shunt');
            svg.appendChild(shuntRouteT3_horizontal);
            
            // 45-degree line (/) - diagonal going DOWN-right from left end of horizontal line (80%, flipped horizontally)
            const shuntRouteT3_diagonal = document.createElementNS('http://www.w3.org/2000/svg', 'line');
            shuntRouteT3_diagonal.setAttribute('x1', shuntRouteT3_startX - shuntRouteT3_size);
            shuntRouteT3_diagonal.setAttribute('y1', shuntRouteT3_centerY);
            shuntRouteT3_diagonal.setAttribute('x2', shuntRouteT3_startX - shuntRouteT3_size / 5);
            shuntRouteT3_diagonal.setAttribute('y2', shuntRouteT3_centerY + shuntRouteT3_size * 0.8);
            shuntRouteT3_diagonal.setAttribute('stroke', getDefaultColor());
            shuntRouteT3_diagonal.setAttribute('stroke-width', '2');
            shuntRouteT3_diagonal.setAttribute('stroke-linecap', 'round');
            shuntRouteT3_diagonal.setAttribute('cursor', 'pointer');
            shuntRouteT3_diagonal.setAttribute('data-signal', 'T3');
            shuntRouteT3_diagonal.onclick = () => handleShuntRouteClick('T3', 'Shunt');
            svg.appendChild(shuntRouteT3_diagonal);

            // ===== TRIANGLE BETWEEN AB AND AA =====
            // Triangle pointing left (towards SELATAN/AB), aligned with VC-VD right triangle
            const triangleGapMidX = vcVd_triangle2_x;  // Same X position as VC-VD right triangle
            const triangleSize = 12;  // Triangle size (half-width from center)
            const triangleY = lowerY;  // Same level as track
            
            const triangle = document.createElementNS('http://www.w3.org/2000/svg', 'polygon');
            triangle.setAttribute('points', `${triangleGapMidX + triangleSize},${triangleY - triangleSize} ${triangleGapMidX + triangleSize},${triangleY + triangleSize} ${triangleGapMidX - triangleSize},${triangleY}`);
            triangle.setAttribute('fill', state.power === 'off' ? '#ff00ff' : '#ffffff');
            triangle.setAttribute('stroke', getDefaultColor());
            triangle.setAttribute('stroke-width', '2');
            triangle.setAttribute('cursor', 'pointer');
            triangle.onclick = () => handleTriangleClick('T5', 'Selatan Direction');
            svg.appendChild(triangle);

            // ===== TRIANGLE BETWEEN AD AND AC =====
            // Triangle pointing left (towards SELATAN), directly adjacent to AD
            const adAcGapMidX = adEnd + 12;  // No gap, directly at 12px offset
            const adAcTriangleY = lowerY;  // Same level as lower track
            
            const triangle_ad_ac = document.createElementNS('http://www.w3.org/2000/svg', 'polygon');
            triangle_ad_ac.setAttribute('points', `${adAcGapMidX + triangleSize},${adAcTriangleY - triangleSize} ${adAcGapMidX + triangleSize},${adAcTriangleY + triangleSize} ${adAcGapMidX - triangleSize},${adAcTriangleY}`);
            triangle_ad_ac.setAttribute('fill', state.power === 'off' ? '#ff00ff' : '#ffffff');
            triangle_ad_ac.setAttribute('stroke', getDefaultColor());
            triangle_ad_ac.setAttribute('stroke-width', '2');
            triangle_ad_ac.setAttribute('cursor', 'pointer');
            triangle_ad_ac.onclick = () => handleTriangleClick('T7', 'Selatan Direction');
            svg.appendChild(triangle_ad_ac);

            // ===== TRIANGLES BETWEEN VA AND VB =====
            // Triangle pointing right (towards UTARA), on left side - at track level
            const vaVbTriangleY = upperY;  // Same level as track
            const triangle_size = 12;
            
            const triangle_va_vb_utara = document.createElementNS('http://www.w3.org/2000/svg', 'polygon');
            triangle_va_vb_utara.setAttribute('points', `${vaVb_triangle1_x - triangle_size},${vaVbTriangleY - triangle_size} ${vaVb_triangle1_x - triangle_size},${vaVbTriangleY + triangle_size} ${vaVb_triangle1_x + triangle_size},${vaVbTriangleY}`);
            triangle_va_vb_utara.setAttribute('fill', state.power === 'off' ? '#ff00ff' : '#ffffff');
            triangle_va_vb_utara.setAttribute('stroke', getDefaultColor());
            triangle_va_vb_utara.setAttribute('stroke-width', '2');
            triangle_va_vb_utara.setAttribute('cursor', 'pointer');
            triangle_va_vb_utara.onclick = () => handleTriangleClick('N4', 'Utara Direction');
            svg.appendChild(triangle_va_vb_utara);

            // Triangle pointing left (towards SELATAN), on right side - at track level
            const triangle_va_vb_selatan = document.createElementNS('http://www.w3.org/2000/svg', 'polygon');
            triangle_va_vb_selatan.setAttribute('points', `${vaVb_triangle2_x + triangle_size},${vaVbTriangleY - triangle_size} ${vaVb_triangle2_x + triangle_size},${vaVbTriangleY + triangle_size} ${vaVb_triangle2_x - triangle_size},${vaVbTriangleY}`);
            triangle_va_vb_selatan.setAttribute('fill', state.power === 'off' ? '#ff00ff' : '#ffffff');
            triangle_va_vb_selatan.setAttribute('stroke', getDefaultColor());
            triangle_va_vb_selatan.setAttribute('stroke-width', '2');
            triangle_va_vb_selatan.setAttribute('cursor', 'pointer');
            triangle_va_vb_selatan.onclick = () => handleTriangleClick('N4', 'Selatan Direction');
            svg.appendChild(triangle_va_vb_selatan);

            // ===== DIAGONAL =====
            // Calculate base DIAG from VC_RIGHT to AB_LEFT
            let diag_base_x1 = vcRight_start - 2;
            let diag_base_y1 = upperY;
            let diag_base_x2 = abLeft_end + 2;
            let diag_base_y2 = lowerY;
            
            // Extend base if only one switch is reversed
            if (state.switches['11A'] === 'REVERSE' && state.switches['11B'] === 'NORMAL') {
                // If 11A is reversed but 11B is normal, extend top to full length
                diag_base_x1 = vcRight_start - 2;
                diag_base_y1 = upperY;
            }
            if (state.switches['11A'] === 'NORMAL' && state.switches['11B'] === 'REVERSE') {
                // If 11B is reversed but 11A is normal, extend bottom to full length
                diag_base_x2 = abLeft_end + 2;
                diag_base_y2 = lowerY;
            }
            
            // Calculate diagonal vector and length
            const diag_dx = diag_base_x2 - diag_base_x1;
            const diag_dy = diag_base_y2 - diag_base_y1;
            const diag_length = Math.sqrt(diag_dx * diag_dx + diag_dy * diag_dy);
            
            // Unit vector along diagonal
            const diag_ux = diag_dx / diag_length;
            const diag_uy = diag_dy / diag_length;
            
            // Adjusted endpoints
            let diag_x1 = diag_base_x1;
            let diag_y1 = diag_base_y1;
            let diag_x2 = diag_base_x2;
            let diag_y2 = diag_base_y2;
            
            // If 11A is NORMAL (inverted), move top end 50px along diagonal
            if (state.switches['11A'] === 'NORMAL') {  // Now shortens when NORMAL
                diag_x1 += diag_ux * 50;
                diag_y1 += diag_uy * 50;
            }
            
            // If 11B is NORMAL (inverted), move bottom end 50px back along diagonal
            if (state.switches['11B'] === 'NORMAL') {  // Now shortens when NORMAL
                diag_x2 -= diag_ux * 50;
                diag_y2 -= diag_uy * 50;
            }
            
            // Draw DIAG with appropriate line caps for each end (inverted logic)
            // Split into two segments with 8px gap in the middle (along diagonal direction)
            const diag_mid_x = (diag_x1 + diag_x2) / 2;
            const diag_mid_y = (diag_y1 + diag_y2) / 2;
            
            // Calculate gap offset along diagonal (4px on each side)
            const gap_distance = 4;
            const diag_split1_x2 = diag_mid_x - diag_ux * gap_distance;
            const diag_split1_y2 = diag_mid_y - diag_uy * gap_distance;
            const diag_split2_x1 = diag_mid_x + diag_ux * gap_distance;
            const diag_split2_y1 = diag_mid_y + diag_uy * gap_distance;
            
            if (state.switches['11A'] === 'NORMAL' && state.switches['11B'] === 'NORMAL') {
                // Both NORMAL: both flat
                const diagLine1 = document.createElementNS('http://www.w3.org/2000/svg', 'line');
                diagLine1.setAttribute('x1', diag_x1);
                diagLine1.setAttribute('y1', diag_y1);
                diagLine1.setAttribute('x2', diag_split1_x2);
                diagLine1.setAttribute('y2', diag_split1_y2);
                diagLine1.setAttribute('stroke', getColor(state.tracks['DIAG']));
                diagLine1.setAttribute('stroke-width', '10');
                diagLine1.setAttribute('stroke-linecap', 'butt');
                svg.appendChild(diagLine1);
                
                const diagLine2 = document.createElementNS('http://www.w3.org/2000/svg', 'line');
                diagLine2.setAttribute('x1', diag_split2_x1);
                diagLine2.setAttribute('y1', diag_split2_y1);
                diagLine2.setAttribute('x2', diag_x2);
                diagLine2.setAttribute('y2', diag_y2);
                diagLine2.setAttribute('stroke', getColor(state.tracks['DIAG']));
                diagLine2.setAttribute('stroke-width', '10');
                diagLine2.setAttribute('stroke-linecap', 'butt');
                svg.appendChild(diagLine2);
            } else if (state.switches['11A'] === 'NORMAL' && state.switches['11B'] === 'REVERSE') {
                // Top flat, bottom round
                const diagLine1 = document.createElementNS('http://www.w3.org/2000/svg', 'line');
                diagLine1.setAttribute('x1', diag_x1);
                diagLine1.setAttribute('y1', diag_y1);
                diagLine1.setAttribute('x2', diag_split1_x2);
                diagLine1.setAttribute('y2', diag_split1_y2);
                diagLine1.setAttribute('stroke', getColor(state.tracks['DIAG']));
                diagLine1.setAttribute('stroke-width', '10');
                diagLine1.setAttribute('stroke-linecap', 'butt');
                svg.appendChild(diagLine1);
                
                const diagLine2 = document.createElementNS('http://www.w3.org/2000/svg', 'line');
                diagLine2.setAttribute('x1', diag_split2_x1);
                diagLine2.setAttribute('y1', diag_split2_y1);
                diagLine2.setAttribute('x2', diag_x2);
                diagLine2.setAttribute('y2', diag_y2);
                diagLine2.setAttribute('stroke', getColor(state.tracks['DIAG']));
                diagLine2.setAttribute('stroke-width', '10');
                diagLine2.setAttribute('stroke-linecap', 'round');  // Round cap at bottom only
                svg.appendChild(diagLine2);
            } else if (state.switches['11A'] === 'REVERSE' && state.switches['11B'] === 'NORMAL') {
                // Top round (smooth connection to VC), bottom flat
                const diagLine1 = document.createElementNS('http://www.w3.org/2000/svg', 'line');
                diagLine1.setAttribute('x1', diag_x1);
                diagLine1.setAttribute('y1', diag_y1);
                diagLine1.setAttribute('x2', diag_split1_x2);
                diagLine1.setAttribute('y2', diag_split1_y2);
                diagLine1.setAttribute('stroke', getColor(state.tracks['DIAG']));
                diagLine1.setAttribute('stroke-width', '10');
                diagLine1.setAttribute('stroke-linecap', 'round');  // Round cap at top for smooth connection
                svg.appendChild(diagLine1);
                
                const diagLine2 = document.createElementNS('http://www.w3.org/2000/svg', 'line');
                diagLine2.setAttribute('x1', diag_split2_x1);
                diagLine2.setAttribute('y1', diag_split2_y1);
                diagLine2.setAttribute('x2', diag_x2);
                diagLine2.setAttribute('y2', diag_y2);
                diagLine2.setAttribute('stroke', getColor(state.tracks['DIAG']));
                diagLine2.setAttribute('stroke-width', '10');
                diagLine2.setAttribute('stroke-linecap', 'butt');
                svg.appendChild(diagLine2);
            } else {
                // Both REVERSE: both round
                const diagLine1 = document.createElementNS('http://www.w3.org/2000/svg', 'line');
                diagLine1.setAttribute('x1', diag_x1);
                diagLine1.setAttribute('y1', diag_y1);
                diagLine1.setAttribute('x2', diag_split1_x2);
                diagLine1.setAttribute('y2', diag_split1_y2);
                diagLine1.setAttribute('stroke', getColor(state.tracks['DIAG']));
                diagLine1.setAttribute('stroke-width', '10');
                diagLine1.setAttribute('stroke-linecap', 'round');
                svg.appendChild(diagLine1);
                
                const diagLine2 = document.createElementNS('http://www.w3.org/2000/svg', 'line');
                diagLine2.setAttribute('x1', diag_split2_x1);
                diagLine2.setAttribute('y1', diag_split2_y1);
                diagLine2.setAttribute('x2', diag_x2);
                diagLine2.setAttribute('y2', diag_y2);
                diagLine2.setAttribute('stroke', getColor(state.tracks['DIAG']));
                diagLine2.setAttribute('stroke-width', '10');
                diagLine2.setAttribute('stroke-linecap', 'round');
                svg.appendChild(diagLine2);
            }
            
            
            // Draw 11A and 11B on top of DIAG if they are visible (inverted logic)
            if (state.switches['11A'] === 'NORMAL') {  // Now shows when NORMAL
                const vc11ALine = document.createElementNS('http://www.w3.org/2000/svg', 'line');
                vc11ALine.setAttribute('x1', vc11A_start - 10);  // Overlap left
                vc11ALine.setAttribute('y1', upperY);
                vc11ALine.setAttribute('x2', vc11A_end + 10);  // Overlap right
                vc11ALine.setAttribute('y2', upperY);
                vc11ALine.setAttribute('stroke', getColor(state.tracks['VC_LEFT']));  // Use VC_LEFT color (same as VC)
                vc11ALine.setAttribute('stroke-width', '10');
                vc11ALine.setAttribute('stroke-linecap', 'butt');
                svg.appendChild(vc11ALine);
            }
            
            // 11A broken indicator (only show when power is ON)
            if (state.switchStates['11A'] === 'broken' && state.power === 'on') {
                const broken11A = document.createElementNS('http://www.w3.org/2000/svg', 'circle');
                broken11A.setAttribute('cx', (vc11A_start + vc11A_end) / 2);  // Center of 11A
                broken11A.setAttribute('cy', upperY);
                broken11A.setAttribute('r', '8');
                broken11A.setAttribute('fill', 'none');
                broken11A.setAttribute('stroke', '#ffff00');  // Yellow
                broken11A.setAttribute('stroke-width', '2');
                broken11A.setAttribute('class', 'broken-ring');
                broken11A.setAttribute('cursor', 'pointer');
                broken11A.onclick = () => toggleSwitchState('11A');
                svg.appendChild(broken11A);
            }
            
            if (state.switches['11B'] === 'NORMAL') {  // Now shows when NORMAL
                const ab11BLine = document.createElementNS('http://www.w3.org/2000/svg', 'line');
                ab11BLine.setAttribute('x1', ab11B_start - 10);  // Overlap left
                ab11BLine.setAttribute('y1', lowerY);
                ab11BLine.setAttribute('x2', ab11B_end + 10);  // Overlap right
                ab11BLine.setAttribute('y2', lowerY);
                ab11BLine.setAttribute('stroke', getColor(state.tracks['AB_LEFT']));  // Use AB_LEFT color (same as AB)
                ab11BLine.setAttribute('stroke-width', '10');
                ab11BLine.setAttribute('stroke-linecap', 'butt');
                svg.appendChild(ab11BLine);
            }
            
            // 11B broken indicator (only show when power is ON)
            if (state.switchStates['11B'] === 'broken' && state.power === 'on') {
                const broken11B = document.createElementNS('http://www.w3.org/2000/svg', 'circle');
                broken11B.setAttribute('cx', (ab11B_start + ab11B_end) / 2);  // Center of 11B
                broken11B.setAttribute('cy', lowerY);
                broken11B.setAttribute('r', '8');
                broken11B.setAttribute('fill', 'none');
                broken11B.setAttribute('stroke', '#ffff00');  // Yellow
                broken11B.setAttribute('stroke-width', '2');
                broken11B.setAttribute('class', 'broken-ring');
                broken11B.setAttribute('cursor', 'pointer');
                broken11B.onclick = () => toggleSwitchState('11B');
                svg.appendChild(broken11B);
            }

            // SELATAN & UTARA labels
            const middleY = (upperY + lowerY) / 2;  // Middle between upper and lower tracks
            drawLabel(startX - 50, middleY, 'SELATAN');
            drawLabel(aaEnd + 50, middleY, 'UTARA');

            // ===== RAILWAY PLATFORM B BETWEEN VA AND AD =====
            // Platform shown as a rectangle between VA (upper) and AD (lower) tracks
            const platformB_X = startX + vaWidth / 2 - 50;  // Centered under VA
            const platformY_top = upperY + 20;  // Below VA track
            const platformY_bottom = lowerY - 20;  // Above AD track
            const platformWidth = 100;  // Width of platform (increased from 60)
            const platformHeight = platformY_bottom - platformY_top;
            
            const platformB = document.createElementNS('http://www.w3.org/2000/svg', 'rect');
            platformB.setAttribute('x', platformB_X);
            platformB.setAttribute('y', platformY_top);
            platformB.setAttribute('width', platformWidth);
            platformB.setAttribute('height', platformHeight);
            platformB.setAttribute('fill', 'none');
            platformB.setAttribute('stroke', getDefaultColor());
            platformB.setAttribute('stroke-width', '2');
            svg.appendChild(platformB);
            
            // Platform B label - positioned at center of platform
            drawLabel(platformB_X + platformWidth / 2, platformY_top + platformHeight / 2, 'Platform B');

            // ===== RAILWAY PLATFORM A BETWEEN VD AND AA =====
            // Platform shown as a rectangle between VD (upper) and AA (lower) tracks
            const platformA_X = vdStart + standardWidth / 2 - 50;  // Centered under VD
            
            const platformA = document.createElementNS('http://www.w3.org/2000/svg', 'rect');
            platformA.setAttribute('x', platformA_X);
            platformA.setAttribute('y', platformY_top);
            platformA.setAttribute('width', platformWidth);
            platformA.setAttribute('height', platformHeight);
            platformA.setAttribute('fill', 'none');
            platformA.setAttribute('stroke', getDefaultColor());
            platformA.setAttribute('stroke-width', '2');
            svg.appendChild(platformA);
            
            // Platform A label - positioned at center of platform
            drawLabel(platformA_X + platformWidth / 2, platformY_top + platformHeight / 2, 'Platform A');

            // ===== SIGNAL BETWEEN VA AND VB =====
            // Pole on VA side (vertical line)
            const signalPoleX = vaEnd + (vbStart - vaEnd) / 2;  // Gap midpoint between VA and VB
            const signalPoleY_top = 20;  // Top of pole
            const signalPoleY_bottom = signalPoleY_top + 20;  // Same length as arm (20px)
            const poleLine = document.createElementNS('http://www.w3.org/2000/svg', 'line');
            poleLine.setAttribute('x1', signalPoleX);
            poleLine.setAttribute('y1', signalPoleY_top);
            poleLine.setAttribute('x2', signalPoleX);
            poleLine.setAttribute('y2', signalPoleY_bottom);
            poleLine.setAttribute('stroke', getDefaultColor());
            poleLine.setAttribute('stroke-width', '3');
            svg.appendChild(poleLine);

            // Lamp circle on VB side (extending from pole)
            const lampX = signalPoleX + 20;  // Arm length 20px
            const lampY = signalPoleY_top + 10;  // Middle of pole
            const lampRadius = 10;

            // Lamp arm (horizontal line from pole to leftmost point of lamp)
            const lampArm = document.createElementNS('http://www.w3.org/2000/svg', 'line');
            lampArm.setAttribute('x1', signalPoleX);
            lampArm.setAttribute('y1', lampY);
            lampArm.setAttribute('x2', lampX - lampRadius);  // End at leftmost point of circle
            lampArm.setAttribute('y2', lampY);
            lampArm.setAttribute('stroke', getDefaultColor());
            lampArm.setAttribute('stroke-width', '2');
            svg.appendChild(lampArm);

            // Lamp circle (color based on state)
            const lampCircle = document.createElementNS('http://www.w3.org/2000/svg', 'circle');
            lampCircle.setAttribute('cx', lampX);
            lampCircle.setAttribute('cy', lampY);
            lampCircle.setAttribute('r', lampRadius);
            lampCircle.setAttribute('fill', state.signals.N4 === 'broken' ? 'none' : getSignalColor(state.signals.N4));
            lampCircle.setAttribute('stroke', getDefaultColor());
            lampCircle.setAttribute('stroke-width', '2');
            lampCircle.setAttribute('cursor', 'pointer');
            lampCircle.onclick = () => cycleSignal('N4');
            svg.appendChild(lampCircle);
            
            // Broken state indicator: larger yellow circle ring (only show when power is ON)
            if (state.signals.N4 === 'broken' && state.power === 'on') {
                const brokenRing = document.createElementNS('http://www.w3.org/2000/svg', 'circle');
                brokenRing.setAttribute('cx', lampX);
                brokenRing.setAttribute('cy', lampY);
                brokenRing.setAttribute('r', lampRadius + 4);  // Smaller offset
                brokenRing.setAttribute('fill', 'none');
                brokenRing.setAttribute('stroke', '#ffff00');  // Yellow
                brokenRing.setAttribute('stroke-width', '2');
                brokenRing.setAttribute('cursor', 'pointer');
                brokenRing.setAttribute('class', 'broken-ring');
                brokenRing.onclick = () => cycleSignal('N4');
                svg.appendChild(brokenRing);
            }
            
            // N4 label on left side before signal pole with red background when ON
            // Background rectangle
            const n4LabelX = signalPoleX - 25;
            const n4LabelY = lampY + 6;
            const n4BgRect = document.createElementNS('http://www.w3.org/2000/svg', 'rect');
            n4BgRect.setAttribute('x', n4LabelX - 15);
            n4BgRect.setAttribute('y', n4LabelY - 12);
            n4BgRect.setAttribute('width', '30');
            n4BgRect.setAttribute('height', '18');
            n4BgRect.setAttribute('fill', state.power === 'on' ? '#ff0000' : 'none');
            n4BgRect.setAttribute('rx', '2');
            svg.appendChild(n4BgRect);
            
            // N4 label text
            drawLabel(n4LabelX, n4LabelY, 'N4');
            
            // ===== SIGNAL T3 BETWEEN VC AND VD (shunt signal, facing VC) =====
            // Pole aligned with triangle base
            const t3PoleX = vcEnd + 32;  // Aligned with VC-VD triangle base (vcEnd + 20 + 12)
            const t3PoleY_top = 20;  // Same as N4 pole top (align with N4)
            const t3PoleY_bottom = t3PoleY_top + 20;  // Pole length
            const t3PoleLine = document.createElementNS('http://www.w3.org/2000/svg', 'line');
            t3PoleLine.setAttribute('x1', t3PoleX);
            t3PoleLine.setAttribute('y1', t3PoleY_top);
            t3PoleLine.setAttribute('x2', t3PoleX);
            t3PoleLine.setAttribute('y2', t3PoleY_bottom);
            t3PoleLine.setAttribute('stroke', getDefaultColor());
            t3PoleLine.setAttribute('stroke-width', '3');
            svg.appendChild(t3PoleLine);

            // Calculate positions from right to left: pole → arm → quarter circle → lamp
            const t3LampRadius = 10;
            const t3PoleLength = 20;
            const t3HoodRadiusX = t3PoleLength * 1.3;
            const t3ArmLength = 8;
            
            // Lamp position (leftmost, on VC side) - aligned with N4 lamp Y position
            const t3LampX = t3PoleX - t3ArmLength - t3HoodRadiusX - t3LampRadius;
            const t3LampY = t3PoleY_top + 10;  // Middle of pole, same as N4 lampY
            
            // Lamp circle
            const t3LampCircle = document.createElementNS('http://www.w3.org/2000/svg', 'circle');
            t3LampCircle.setAttribute('cx', t3LampX);
            t3LampCircle.setAttribute('cy', t3LampY);
            t3LampCircle.setAttribute('r', t3LampRadius);
            t3LampCircle.setAttribute('fill', state.signals.T3 === 'broken' ? 'none' : getSignalColor(state.signals.T3));
            t3LampCircle.setAttribute('stroke', getDefaultColor());
            t3LampCircle.setAttribute('stroke-width', '2');
            t3LampCircle.setAttribute('cursor', 'pointer');
            t3LampCircle.onclick = () => cycleSignalT3();
            svg.appendChild(t3LampCircle);
            
            // Broken state indicator: larger yellow circle ring (only show when power is ON)
            if (state.signals.T3 === 'broken' && state.power === 'on') {
                const brokenRing = document.createElementNS('http://www.w3.org/2000/svg', 'circle');
                brokenRing.setAttribute('cx', t3LampX);
                brokenRing.setAttribute('cy', t3LampY);
                brokenRing.setAttribute('r', t3LampRadius + 4);
                brokenRing.setAttribute('fill', 'none');
                brokenRing.setAttribute('stroke', '#ffff00');  // Yellow
                brokenRing.setAttribute('stroke-width', '2');
                brokenRing.setAttribute('cursor', 'pointer');
                brokenRing.setAttribute('class', 'broken-ring');
                brokenRing.onclick = () => cycleSignalT3();
                svg.appendChild(brokenRing);
            }
            
            // T3 label on right side after signal pole with red background when ON
            // Background rectangle
            const t3LabelX = t3PoleX + 25;
            const t3LabelY = t3LampY + 6;
            const t3BgRect = document.createElementNS('http://www.w3.org/2000/svg', 'rect');
            t3BgRect.setAttribute('x', t3LabelX - 15);
            t3BgRect.setAttribute('y', t3LabelY - 12);
            t3BgRect.setAttribute('width', '30');
            t3BgRect.setAttribute('height', '18');
            t3BgRect.setAttribute('fill', state.power === 'on' ? '#ff0000' : 'none');
            t3BgRect.setAttribute('rx', '2');
            svg.appendChild(t3BgRect);
            
            // T3 label text
            drawLabel(t3LabelX, t3LabelY, 'T3');
            
            // Quarter circle hood - same orientation as T5 (straight lines on top and right)
            const t3HoodRadiusY = t3PoleLength;
            const t3HoodCenterX = t3LampX + t3LampRadius + t3HoodRadiusX;
            const t3HoodCenterY = t3LampY - t3LampRadius;  // Top of lamp (same as T5)
            
            // Path: Same as T5 - horizontal line at top, vertical line on right, curve at bottom
            const t3HoodPath = `M ${t3HoodCenterX},${t3HoodCenterY}
                              L ${t3HoodCenterX - t3HoodRadiusX},${t3HoodCenterY}
                              A ${t3HoodRadiusX},${t3HoodRadiusY} 0 0,0 ${t3HoodCenterX},${t3HoodCenterY + t3HoodRadiusY}
                              Z`;
            
            const t3Hood = document.createElementNS('http://www.w3.org/2000/svg', 'path');
            t3Hood.setAttribute('d', t3HoodPath);
            t3Hood.setAttribute('fill', state.hoods.T3 === 'filled' ? '#0066ff' : 'none');
            t3Hood.setAttribute('stroke', getDefaultColor());
            t3Hood.setAttribute('stroke-width', '2');
            t3Hood.setAttribute('stroke-linejoin', 'miter');
            t3Hood.setAttribute('cursor', 'pointer');
            t3Hood.onclick = () => toggleHood('T3');
            svg.appendChild(t3Hood);

            // Diagonal line inside hood when filled - 45 degree angle with equal gaps
            if (state.hoods.T3 === 'filled') {
                const t3DiagLine = document.createElementNS('http://www.w3.org/2000/svg', 'line');
                // Start point: APEX with gap
                const gapFromApex = 5;
                const startX = t3HoodCenterX - gapFromApex;
                const startY = t3HoodCenterY + gapFromApex;
                // End point: 45 degree angle with larger gap from arc (7px)
                const gapFromArc = 7;
                const diagDistance = Math.min(t3HoodRadiusX, t3HoodRadiusY) - gapFromApex - gapFromArc;
                const endX = startX - diagDistance;  // Move left same amount as down (45 degrees)
                const endY = startY + diagDistance;  // Move down
                t3DiagLine.setAttribute('x1', startX);
                t3DiagLine.setAttribute('y1', startY);
                t3DiagLine.setAttribute('x2', endX);
                t3DiagLine.setAttribute('y2', endY);
                t3DiagLine.setAttribute('stroke', getDefaultColor());
                t3DiagLine.setAttribute('stroke-width', '2');
                svg.appendChild(t3DiagLine);
            }

            // Arm (horizontal line from pole center to rightmost point of hood)
            const t3ArmStartX = t3HoodCenterX;
            const t3ArmEndX = t3PoleX;
            const t3LampArm = document.createElementNS('http://www.w3.org/2000/svg', 'line');
            t3LampArm.setAttribute('x1', t3PoleX);  // Start from pole center
            t3LampArm.setAttribute('y1', t3LampY);
            t3LampArm.setAttribute('x2', t3HoodCenterX);  // End at hood center (rightmost point of hood)
            t3LampArm.setAttribute('y2', t3LampY);
            t3LampArm.setAttribute('stroke', getDefaultColor());
            t3LampArm.setAttribute('stroke-width', '2');
            svg.appendChild(t3LampArm);
            
            // T3 label above signal (same position relative to lamp as N4)
            drawLabel(t3LampX + 5, t3LampY - 20, 'T3');
            
            // ===== SIGNAL T7 BETWEEN AD AND AC (facing AD) =====
            // Pole aligned with triangle base
            const t7PoleX = adEnd + 32;  // Aligned with AD-AC triangle base (adEnd + 20 + 12)
            const t7PoleY_top = lowerY + 40;  // Below the track
            const t7PoleY_bottom = t7PoleY_top + 20;  // Pole length 20px
            const t7PoleLine = document.createElementNS('http://www.w3.org/2000/svg', 'line');
            t7PoleLine.setAttribute('x1', t7PoleX);
            t7PoleLine.setAttribute('y1', t7PoleY_top);
            t7PoleLine.setAttribute('x2', t7PoleX);
            t7PoleLine.setAttribute('y2', t7PoleY_bottom);
            t7PoleLine.setAttribute('stroke', getDefaultColor());
            t7PoleLine.setAttribute('stroke-width', '3');
            svg.appendChild(t7PoleLine);

            // Lamp on AD side (extending left from pole)
            const t7LampX = t7PoleX - 20;  // 20px to the left (AD side)
            const t7LampY = t7PoleY_top + 10;  // Middle of pole
            const t7LampRadius = 10;

            // Lamp arm (horizontal line from pole to lamp edge)
            const t7LampArm = document.createElementNS('http://www.w3.org/2000/svg', 'line');
            t7LampArm.setAttribute('x1', t7PoleX);
            t7LampArm.setAttribute('y1', t7LampY);
            t7LampArm.setAttribute('x2', t7LampX + t7LampRadius);  // End at rightmost point of lamp circle
            t7LampArm.setAttribute('y2', t7LampY);
            t7LampArm.setAttribute('stroke', getDefaultColor());
            t7LampArm.setAttribute('stroke-width', '2');
            svg.appendChild(t7LampArm);

            // Lamp circle (color based on state)
            const t7LampCircle = document.createElementNS('http://www.w3.org/2000/svg', 'circle');
            t7LampCircle.setAttribute('cx', t7LampX);
            t7LampCircle.setAttribute('cy', t7LampY);
            t7LampCircle.setAttribute('r', t7LampRadius);
            t7LampCircle.setAttribute('fill', state.signals.T7 === 'broken' ? 'none' : getSignalColor(state.signals.T7));
            t7LampCircle.setAttribute('stroke', getDefaultColor());
            t7LampCircle.setAttribute('stroke-width', '2');
            t7LampCircle.setAttribute('cursor', 'pointer');
            t7LampCircle.onclick = () => cycleSignal('T7');
            svg.appendChild(t7LampCircle);
            
            // Broken state indicator: larger yellow circle ring (only show when power is ON)
            if (state.signals.T7 === 'broken' && state.power === 'on') {
                const brokenRing = document.createElementNS('http://www.w3.org/2000/svg', 'circle');
                brokenRing.setAttribute('cx', t7LampX);
                brokenRing.setAttribute('cy', t7LampY);
                brokenRing.setAttribute('r', t7LampRadius + 4);
                brokenRing.setAttribute('fill', 'none');
                brokenRing.setAttribute('stroke', '#ffff00');  // Yellow
                brokenRing.setAttribute('stroke-width', '2');
                brokenRing.setAttribute('cursor', 'pointer');
                brokenRing.setAttribute('class', 'broken-ring');
                brokenRing.onclick = () => cycleSignal('T7');
                svg.appendChild(brokenRing);
            }
            
            // T7 label on right side after signal pole with red background when ON (facing left)
            // Background rectangle
            const t7LabelX = t7PoleX + 25;
            const t7LabelY = t7LampY + 6;
            const t7BgRect = document.createElementNS('http://www.w3.org/2000/svg', 'rect');
            t7BgRect.setAttribute('x', t7LabelX - 15);
            t7BgRect.setAttribute('y', t7LabelY - 12);
            t7BgRect.setAttribute('width', '30');
            t7BgRect.setAttribute('height', '18');
            t7BgRect.setAttribute('fill', state.power === 'on' ? '#ff0000' : 'none');
            t7BgRect.setAttribute('rx', '2');
            svg.appendChild(t7BgRect);
            
            // T7 label text
            drawLabel(t7LabelX, t7LabelY, 'T7');
            
            // ===== SIGNAL S6 BETWEEN AC AND AB (shunt signal, facing AB, no lamp) =====
            // Pole in the gap midpoint
            const s6PoleX = acStart + standardWidth + 8 + (abStart - (acStart + standardWidth + 8)) / 2;
            const s6PoleY_top = lowerY + 40;  // Below the track
            const s6PoleY_bottom = s6PoleY_top + 20;  // Pole length
            const s6PoleLine = document.createElementNS('http://www.w3.org/2000/svg', 'line');
            s6PoleLine.setAttribute('x1', s6PoleX);
            s6PoleLine.setAttribute('y1', s6PoleY_top);
            s6PoleLine.setAttribute('x2', s6PoleX);
            s6PoleLine.setAttribute('y2', s6PoleY_bottom);
            s6PoleLine.setAttribute('stroke', getDefaultColor());
            s6PoleLine.setAttribute('stroke-width', '3');
            svg.appendChild(s6PoleLine);

            // Calculate positions: pole → arm → quarter circle (no lamp, facing AB/right)
            const s6PoleLength = 20;  // Same as s6PoleY_bottom - s6PoleY_top
            const s6HoodRadiusX = s6PoleLength * 1.3;  // Horizontal radius - wider
            const s6ArmLength = 8;  // Space between pole and hood
            
            // Hood center Y should be positioned so bottom line aligns with pole bottom, moved up 10px
            const s6HoodY = s6PoleY_bottom - s6PoleLength / 2 - 10;  // Moved up by 10px
            
            // Arm ends at s6PoleX + s6ArmLength, so hood center X should be there
            const s6HoodX = s6PoleX + s6ArmLength;
            
            // Quarter circle hood (facing right, flipped vertically and horizontally)
            const s6HoodRadiusY = s6PoleLength;  // Vertical radius - same as pole length
            const s6HoodPath = `M ${s6HoodX},${s6HoodY + s6HoodRadiusY}
                              L ${s6HoodX + s6HoodRadiusX},${s6HoodY + s6HoodRadiusY}
                              A ${s6HoodRadiusX},${s6HoodRadiusY} 0 0,0 ${s6HoodX},${s6HoodY}
                              Z`;
            
            const s6Hood = document.createElementNS('http://www.w3.org/2000/svg', 'path');
            s6Hood.setAttribute('d', s6HoodPath);
            s6Hood.setAttribute('fill', state.hoods.S6 === 'filled' ? '#0066ff' : 'none');
            s6Hood.setAttribute('stroke', getDefaultColor());
            s6Hood.setAttribute('stroke-width', '2');
            s6Hood.setAttribute('stroke-linejoin', 'miter');
            s6Hood.setAttribute('cursor', 'pointer');
            s6Hood.onclick = () => toggleHood('S6');
            svg.appendChild(s6Hood);

            // Diagonal line inside hood when filled - 45 degree angle from APEX to ARC with gaps
            if (state.hoods.S6 === 'filled') {
                const s6DiagLine = document.createElementNS('http://www.w3.org/2000/svg', 'line');
                // Start point: APEX (where left line meets bottom line - BOTTOM LEFT corner) with gap
                const gapFromApex = 5;
                const startX = s6HoodX + gapFromApex;  // Move right from apex
                const startY = s6HoodY + s6HoodRadiusY - gapFromApex;  // Move up from apex (bottom corner)
                // End point: 45 degree angle with gap from arc (7px)
                const gapFromArc = 7;
                const diagDistance = Math.min(s6HoodRadiusX, s6HoodRadiusY) - gapFromApex - gapFromArc;
                const endX = startX + diagDistance;  // Move right same amount as up (45 degrees, toward arc)
                const endY = startY - diagDistance;  // Move up
                s6DiagLine.setAttribute('x1', startX);
                s6DiagLine.setAttribute('y1', startY);
                s6DiagLine.setAttribute('x2', endX);
                s6DiagLine.setAttribute('y2', endY);
                s6DiagLine.setAttribute('stroke', getDefaultColor());
                s6DiagLine.setAttribute('stroke-width', '2');
                svg.appendChild(s6DiagLine);
            }

            // Arm (horizontal line from pole to hood) - moved down 10px
            const s6ArmStartX = s6PoleX;
            const s6ArmEndX = s6HoodX;
            const s6Arm = document.createElementNS('http://www.w3.org/2000/svg', 'line');
            s6Arm.setAttribute('x1', s6ArmStartX);
            s6Arm.setAttribute('y1', s6HoodY + 10);  // Moved down 10px
            s6Arm.setAttribute('x2', s6ArmEndX);
            s6Arm.setAttribute('y2', s6HoodY + 10);  // Moved down 10px
            s6Arm.setAttribute('stroke', getDefaultColor());
            s6Arm.setAttribute('stroke-width', '2');
            svg.appendChild(s6Arm);
            
            // S6 label on left side before signal pole with red background when ON (hood faces right)
            // Background rectangle
            const s6LabelX = s6PoleX - 25;
            const s6LabelY = s6HoodY + 10 + 6;
            const s6BgRect = document.createElementNS('http://www.w3.org/2000/svg', 'rect');
            s6BgRect.setAttribute('x', s6LabelX - 15);
            s6BgRect.setAttribute('y', s6LabelY - 12);
            s6BgRect.setAttribute('width', '30');
            s6BgRect.setAttribute('height', '18');
            s6BgRect.setAttribute('fill', state.power === 'on' ? '#ff0000' : 'none');
            s6BgRect.setAttribute('rx', '2');
            svg.appendChild(s6BgRect);
            
            // S6 label text
            drawLabel(s6LabelX, s6LabelY, 'S6');
            
            // ===== SIGNAL T5 BETWEEN AB AND AA (shunt signal, facing AB) =====
            // Pole aligned with triangle base
            const t5PoleX = abRight_end + 32;  // Aligned with AB-AA triangle base (abRight_end + 20 + 12)
            const t5PoleY_top = lowerY + 40;  // Below the track
            const t5PoleY_bottom = t5PoleY_top + 20;  // Pole length
            const t5PoleLine = document.createElementNS('http://www.w3.org/2000/svg', 'line');
            t5PoleLine.setAttribute('x1', t5PoleX);
            t5PoleLine.setAttribute('y1', t5PoleY_top);
            t5PoleLine.setAttribute('x2', t5PoleX);
            t5PoleLine.setAttribute('y2', t5PoleY_bottom);
            t5PoleLine.setAttribute('stroke', getDefaultColor());
            t5PoleLine.setAttribute('stroke-width', '3');
            svg.appendChild(t5PoleLine);

            // Calculate positions from right to left: pole → arm → quarter circle → lamp
            const t5LampRadius = 10;
            const poleLength = 20;  // Same as t5PoleY_bottom - t5PoleY_top
            const hoodRadiusX = poleLength * 1.3;  // Horizontal radius - wider
            const armLength = 8;  // Space between pole and quarter circle
            
            // Lamp position (leftmost, on AB side)
            const t5LampX = t5PoleX - armLength - hoodRadiusX - t5LampRadius;
            const t5LampY = t5PoleY_top + 10;  // Middle of pole
            
            // Lamp circle
            const t5LampCircle = document.createElementNS('http://www.w3.org/2000/svg', 'circle');
            t5LampCircle.setAttribute('cx', t5LampX);
            t5LampCircle.setAttribute('cy', t5LampY);
            t5LampCircle.setAttribute('r', t5LampRadius);
            t5LampCircle.setAttribute('fill', state.signals.T5 === 'broken' ? 'none' : getSignalColor(state.signals.T5));
            t5LampCircle.setAttribute('stroke', getDefaultColor());
            t5LampCircle.setAttribute('stroke-width', '2');
            t5LampCircle.setAttribute('cursor', 'pointer');
            t5LampCircle.onclick = () => cycleSignalT5();
            svg.appendChild(t5LampCircle);
            
            // Broken state indicator: larger yellow circle ring (only show when power is ON)
            if (state.signals.T5 === 'broken' && state.power === 'on') {
                const brokenRing = document.createElementNS('http://www.w3.org/2000/svg', 'circle');
                brokenRing.setAttribute('cx', t5LampX);
                brokenRing.setAttribute('cy', t5LampY);
                brokenRing.setAttribute('r', t5LampRadius + 4);
                brokenRing.setAttribute('fill', 'none');
                brokenRing.setAttribute('stroke', '#ffff00');  // Yellow
                brokenRing.setAttribute('stroke-width', '2');
                brokenRing.setAttribute('cursor', 'pointer');
                brokenRing.setAttribute('class', 'broken-ring');
                brokenRing.onclick = () => cycleSignalT5();
                svg.appendChild(brokenRing);
            }
            
            // Quarter circle hood - left edge starts at rightmost point of lamp circle
            // Top straight line aligns with topmost point of lamp circle
            const hoodRadiusY = poleLength;  // Vertical radius - same as pole length
            const hoodCenterX = t5LampX + t5LampRadius + hoodRadiusX;  // Center is one radius away from lamp edge
            const hoodCenterY = t5LampY - t5LampRadius;  // Center at the top of the lamp circle
            
            // Path: Start at center (leftmost point), line left (horizontal top), arc down (elliptical curve), line back to center (vertical left)
            const hoodPath = `M ${hoodCenterX},${hoodCenterY}
                              L ${hoodCenterX - hoodRadiusX},${hoodCenterY}
                              A ${hoodRadiusX},${hoodRadiusY} 0 0,0 ${hoodCenterX},${hoodCenterY + hoodRadiusY}
                              Z`;
            
            const t5Hood = document.createElementNS('http://www.w3.org/2000/svg', 'path');
            t5Hood.setAttribute('d', hoodPath);
            t5Hood.setAttribute('fill', state.hoods.T5 === 'filled' ? '#0066ff' : 'none');
            t5Hood.setAttribute('stroke', getDefaultColor());
            t5Hood.setAttribute('stroke-width', '2');
            t5Hood.setAttribute('stroke-linejoin', 'miter');
            t5Hood.setAttribute('cursor', 'pointer');
            t5Hood.onclick = () => toggleHood('T5');
            svg.appendChild(t5Hood);

            // Diagonal line inside hood when filled - 45 degree angle with equal gaps
            if (state.hoods.T5 === 'filled') {
                const t5DiagLine = document.createElementNS('http://www.w3.org/2000/svg', 'line');
                // Start point: APEX with gap
                const gapFromApex = 5;
                const startX = hoodCenterX - gapFromApex;
                const startY = hoodCenterY + gapFromApex;
                // End point: 45 degree angle with larger gap from arc (7px)
                const gapFromArc = 7;
                const diagDistance = Math.min(hoodRadiusX, hoodRadiusY) - gapFromApex - gapFromArc;
                const endX = startX - diagDistance;  // Move left same amount as down (45 degrees)
                const endY = startY + diagDistance;  // Move down
                t5DiagLine.setAttribute('x1', startX);
                t5DiagLine.setAttribute('y1', startY);
                t5DiagLine.setAttribute('x2', endX);
                t5DiagLine.setAttribute('y2', endY);
                t5DiagLine.setAttribute('stroke', getDefaultColor());
                t5DiagLine.setAttribute('stroke-width', '2');
                svg.appendChild(t5DiagLine);
            }

            // Arm (horizontal line from pole center to hood center)
            const armStartX = hoodCenterX;  // Start where quarter circle center is
            const armEndX = t5PoleX;  // End at pole
            const t5LampArm = document.createElementNS('http://www.w3.org/2000/svg', 'line');
            t5LampArm.setAttribute('x1', t5PoleX);  // Start from pole center
            t5LampArm.setAttribute('y1', t5LampY);
            t5LampArm.setAttribute('x2', hoodCenterX);  // End at hood center (rightmost point of hood)
            t5LampArm.setAttribute('y2', t5LampY);
            t5LampArm.setAttribute('stroke', getDefaultColor());
            t5LampArm.setAttribute('stroke-width', '2');
            svg.appendChild(t5LampArm);
            
            // T5 label on right side after signal pole with red background when ON (facing left)
            // Background rectangle
            const t5LabelX = t5PoleX + 25;
            const t5LabelY = t5LampY + 6;
            const t5BgRect = document.createElementNS('http://www.w3.org/2000/svg', 'rect');
            t5BgRect.setAttribute('x', t5LabelX - 15);
            t5BgRect.setAttribute('y', t5LabelY - 12);
            t5BgRect.setAttribute('width', '30');
            t5BgRect.setAttribute('height', '18');
            t5BgRect.setAttribute('fill', state.power === 'on' ? '#ff0000' : 'none');
            t5BgRect.setAttribute('rx', '2');
            svg.appendChild(t5BgRect);
            
            // T5 label text
            drawLabel(t5LabelX, t5LabelY, 'T5');
        }

        // ════════════════════════════════════════════════════════════════
        // 7. CONTROL PANEL UI BUILDER
        // ════════════════════════════════════════════════════════════════
        function updateControls() {
            const container = document.getElementById('trackControls');
            container.innerHTML = '';

            // Switches section
            let div = document.createElement('div');
            div.className = 'section-title';
            div.textContent = 'POINT MACHINES';
            container.appendChild(div);

            // 11A Switch
            div = document.createElement('div');
            div.className = 'track-item';
            let label = document.createElement('div');
            label.className = 'track-name';
            label.textContent = '11A';
            let btnGroup = document.createElement('div');
            btnGroup.className = 'btn-group';
            
            let btnNormal = document.createElement('button');
            btnNormal.textContent = 'NORMAL';
            btnNormal.className = state.switches['11A'] === 'NORMAL' ? 'active' : '';
            btnNormal.onclick = () => toggleSwitch('11A');
            
            let btnReverse = document.createElement('button');
            btnReverse.textContent = 'REVERSE';
            btnReverse.className = state.switches['11A'] === 'REVERSE' ? 'active' : '';
            btnReverse.onclick = () => toggleSwitch('11A');
            
            btnGroup.appendChild(btnNormal);
            btnGroup.appendChild(btnReverse);
            div.appendChild(label);
            div.appendChild(btnGroup);
            
            // 11A OK/broken buttons
            let stateGroup = document.createElement('div');
            stateGroup.className = 'btn-group';
            
            let btnOK = document.createElement('button');
            btnOK.textContent = 'OK';
            btnOK.className = state.switchStates['11A'] === 'OK' ? 'active' : '';
            btnOK.onclick = () => toggleSwitchState('11A');
            
            let btnBroken = document.createElement('button');
            btnBroken.textContent = 'BROKEN';
            btnBroken.className = state.switchStates['11A'] === 'broken' ? 'active' : '';
            btnBroken.onclick = () => toggleSwitchState('11A');
            
            stateGroup.appendChild(btnOK);
            stateGroup.appendChild(btnBroken);
            div.appendChild(stateGroup);
            container.appendChild(div);

            // 11B Switch
            div = document.createElement('div');
            div.className = 'track-item';
            label = document.createElement('div');
            label.className = 'track-name';
            label.textContent = '11B';
            btnGroup = document.createElement('div');
            btnGroup.className = 'btn-group';
            
            btnNormal = document.createElement('button');
            btnNormal.textContent = 'NORMAL';
            btnNormal.className = state.switches['11B'] === 'NORMAL' ? 'active' : '';
            btnNormal.onclick = () => toggleSwitch('11B');
            
            btnReverse = document.createElement('button');
            btnReverse.textContent = 'REVERSE';
            btnReverse.className = state.switches['11B'] === 'REVERSE' ? 'active' : '';
            btnReverse.onclick = () => toggleSwitch('11B');
            
            btnGroup.appendChild(btnNormal);
            btnGroup.appendChild(btnReverse);
            div.appendChild(label);
            div.appendChild(btnGroup);
            
            // 11B OK/broken buttons
            stateGroup = document.createElement('div');
            stateGroup.className = 'btn-group';
            
            btnOK = document.createElement('button');
            btnOK.textContent = 'OK';
            btnOK.className = state.switchStates['11B'] === 'OK' ? 'active' : '';
            btnOK.onclick = () => toggleSwitchState('11B');
            
            btnBroken = document.createElement('button');
            btnBroken.textContent = 'BROKEN';
            btnBroken.className = state.switchStates['11B'] === 'broken' ? 'active' : '';
            btnBroken.onclick = () => toggleSwitchState('11B');
            
            stateGroup.appendChild(btnOK);
            stateGroup.appendChild(btnBroken);
            div.appendChild(stateGroup);
            container.appendChild(div);

            // Signals section
            div = document.createElement('div');
            div.className = 'section-title';
            div.textContent = 'SIGNALS';
            container.appendChild(div);

            // N4 Signal
            div = document.createElement('div');
            div.className = 'track-item';
            label = document.createElement('div');
            label.className = 'track-name';
            label.textContent = 'N4';
            const signalBtn = document.createElement('button');
            signalBtn.className = `track-btn ${state.signals['N4']}`;
            signalBtn.textContent = state.signals['N4'].toUpperCase();
            signalBtn.onclick = () => cycleSignal('N4');
            div.appendChild(label);
            div.appendChild(signalBtn);
            container.appendChild(div);

            // T7 Signal
            div = document.createElement('div');
            div.className = 'track-item';
            label = document.createElement('div');
            label.className = 'track-name';
            label.textContent = 'T7';
            const t7SignalBtn = document.createElement('button');
            t7SignalBtn.className = `track-btn ${state.signals['T7']}`;
            t7SignalBtn.textContent = state.signals['T7'].toUpperCase();
            t7SignalBtn.onclick = () => cycleSignal('T7');
            div.appendChild(label);
            div.appendChild(t7SignalBtn);
            container.appendChild(div);

            // S6 Signal (shunt signal)
            div = document.createElement('div');
            div.className = 'track-item';
            label = document.createElement('div');
            label.className = 'track-name';
            label.textContent = 'S6';
            const s6SignalBtn = document.createElement('button');
            s6SignalBtn.className = `track-btn ${state.signals.S6}`;
            s6SignalBtn.textContent = state.signals.S6.toUpperCase();
            s6SignalBtn.onclick = () => cycleSignalS6();
            div.appendChild(label);
            div.appendChild(s6SignalBtn);
            container.appendChild(div);

            // T5 Signal (shunt signal)
            div = document.createElement('div');
            div.className = 'track-item';
            label = document.createElement('div');
            label.className = 'track-name';
            label.textContent = 'T5';
            const t5SignalBtn = document.createElement('button');
            t5SignalBtn.className = `track-btn ${state.signals.T5}`;
            t5SignalBtn.textContent = state.signals.T5.toUpperCase();
            t5SignalBtn.onclick = () => cycleSignalT5();
            div.appendChild(label);
            div.appendChild(t5SignalBtn);
            container.appendChild(div);

            // T3 Signal (shunt signal)
            div = document.createElement('div');
            div.className = 'track-item';
            label = document.createElement('div');
            label.className = 'track-name';
            label.textContent = 'T3';
            const t3SignalBtn = document.createElement('button');
            t3SignalBtn.className = `track-btn ${state.signals.T3}`;
            t3SignalBtn.textContent = state.signals.T3.toUpperCase();
            t3SignalBtn.onclick = () => cycleSignalT3();
            div.appendChild(label);
            div.appendChild(t3SignalBtn);
            container.appendChild(div);

            // Hoods section
            div = document.createElement('div');
            div.className = 'section-title';
            div.textContent = 'HOODS';
            container.appendChild(div);

            // T5 Hood
            div = document.createElement('div');
            div.className = 'track-item';
            label = document.createElement('div');
            label.className = 'track-name';
            label.textContent = 'T5 Hood';
            btnGroup = document.createElement('div');
            btnGroup.className = 'btn-group';
            
            btnEmpty = document.createElement('button');
            btnEmpty.textContent = 'EMPTY';
            btnEmpty.className = state.hoods.T5 === 'empty' ? 'active' : '';
            btnEmpty.onclick = () => {
                if (state.hoods.T5 !== 'empty') toggleHood('T5');
            };
            
            btnFilled = document.createElement('button');
            btnFilled.textContent = 'FILLED';
            btnFilled.className = state.hoods.T5 === 'filled' ? 'active' : '';
            btnFilled.onclick = () => {
                if (state.hoods.T5 !== 'filled') toggleHood('T5');
            };
            
            btnGroup.appendChild(btnEmpty);
            btnGroup.appendChild(btnFilled);
            div.appendChild(label);
            div.appendChild(btnGroup);
            container.appendChild(div);

            // S6 Hood
            div = document.createElement('div');
            div.className = 'track-item';
            label = document.createElement('div');
            label.className = 'track-name';
            label.textContent = 'S6 Hood';
            btnGroup = document.createElement('div');
            btnGroup.className = 'btn-group';
            
            btnEmpty = document.createElement('button');
            btnEmpty.textContent = 'EMPTY';
            btnEmpty.className = state.hoods.S6 === 'empty' ? 'active' : '';
            btnEmpty.onclick = () => {
                if (state.hoods.S6 !== 'empty') toggleHood('S6');
            };
            
            btnFilled = document.createElement('button');
            btnFilled.textContent = 'FILLED';
            btnFilled.className = state.hoods.S6 === 'filled' ? 'active' : '';
            btnFilled.onclick = () => {
                if (state.hoods.S6 !== 'filled') toggleHood('S6');
            };
            
            btnGroup.appendChild(btnEmpty);
            btnGroup.appendChild(btnFilled);
            div.appendChild(label);
            div.appendChild(btnGroup);
            container.appendChild(div);

            // T3 Hood
            div = document.createElement('div');
            div.className = 'track-item';
            label = document.createElement('div');
            label.className = 'track-name';
            label.textContent = 'T3 Hood';
            btnGroup = document.createElement('div');
            btnGroup.className = 'btn-group';
            
            btnEmpty = document.createElement('button');
            btnEmpty.textContent = 'EMPTY';
            btnEmpty.className = state.hoods.T3 === 'empty' ? 'active' : '';
            btnEmpty.onclick = () => {
                if (state.hoods.T3 !== 'empty') toggleHood('T3');
            };
            
            btnFilled = document.createElement('button');
            btnFilled.textContent = 'FILLED';
            btnFilled.className = state.hoods.T3 === 'filled' ? 'active' : '';
            btnFilled.onclick = () => {
                if (state.hoods.T3 !== 'filled') toggleHood('T3');
            };
            
            btnGroup.appendChild(btnEmpty);
            btnGroup.appendChild(btnFilled);
            div.appendChild(label);
            div.appendChild(btnGroup);
            container.appendChild(div);

            // Track sections section
            div = document.createElement('div');
            div.className = 'section-title';
            div.textContent = 'TRACK SECTIONS';
            container.appendChild(div);

            // Upper line sections
            ['VA', 'VB', 'VC_LEFT', 'VC_11A', 'VC_RIGHT', 'VD'].forEach(trackName => {
                if (trackName === 'VC_11A' && state.switches['11A'] === 'NORMAL') return;
                
                div = document.createElement('div');
                div.className = 'track-item';
                label = document.createElement('div');
                label.className = 'track-name';
                label.textContent = trackName.replace(/_/g, ' ');
                let btn = document.createElement('button');
                btn.className = `track-btn ${state.tracks[trackName]}`;
                btn.textContent = state.tracks[trackName].toUpperCase();
                btn.onclick = () => cycleState(trackName);
                div.appendChild(label);
                div.appendChild(btn);
                container.appendChild(div);
            });

            // Lower line sections
            ['AD', 'AC', 'AB_LEFT', 'AB_11B', 'AB_RIGHT', 'AA'].forEach(trackName => {
                if (trackName === 'AB_11B' && state.switches['11B'] === 'NORMAL') return;
                
                div = document.createElement('div');
                div.className = 'track-item';
                label = document.createElement('div');
                label.className = 'track-name';
                label.textContent = trackName.replace(/_/g, ' ');
                let btn = document.createElement('button');
                btn.className = `track-btn ${state.tracks[trackName]}`;
                btn.textContent = state.tracks[trackName].toUpperCase();
                btn.onclick = () => cycleState(trackName);
                div.appendChild(label);
                div.appendChild(btn);
                container.appendChild(div);
            });

            // DIAG section
            div = document.createElement('div');
            div.className = 'track-item';
            label = document.createElement('div');
            label.className = 'track-name';
            label.textContent = 'DIAG';
            let btn = document.createElement('button');
            btn.className = `track-btn ${state.tracks['DIAG']}`;
            btn.textContent = state.tracks['DIAG'].toUpperCase();
            btn.onclick = () => cycleState('DIAG');
            div.appendChild(label);
            div.appendChild(btn);
            container.appendChild(div);
        }

        // ════════════════════════════════════════════════════════════════
        // 8. MAIN RENDER & INITIALIZATION
        // ════════════════════════════════════════════════════════════════
        function render() {
            drawTrack();
            updateControls();
            
            // Update controls visibility based on power state
            const controlsDiv = document.querySelector('.controls');
            if (state.power === 'off') {
                controlsDiv.classList.add('disabled');
            } else {
                controlsDiv.classList.remove('disabled');
            }
        }

        function initializeEventListeners() {
            const powerBtn = document.getElementById('powerBtn');
            const vduBtn = document.getElementById('vduBtn');
            const dominoBtn = document.getElementById('dominoBtn');
            
            powerBtn.addEventListener('click', togglePower);
            vduBtn.addEventListener('click', () => setMode('vdu'));
            dominoBtn.addEventListener('click', () => setMode('domino'));
        }

        render();
        initializeEventListeners();
    </script>
</body>
</html>
